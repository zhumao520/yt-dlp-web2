name: ğŸš€ å¿«é€Ÿæµ‹è¯•

on:
  workflow_dispatch:
    inputs:
      test_type:
        description: 'æµ‹è¯•ç±»å‹'
        required: true
        default: 'basic'
        type: choice
        options:
        - 'basic'      # åŸºç¡€åŠŸèƒ½æµ‹è¯•
        - 'docker'     # Dockerå®¹å™¨æµ‹è¯•
        - 'full'       # å®Œæ•´åŠŸèƒ½æµ‹è¯•
      skip_build:
        description: 'è·³è¿‡æ„å»ºæ­¥éª¤'
        required: false
        default: false
        type: boolean

jobs:
  quick-test:
    name: ğŸ§ª å¿«é€Ÿæµ‹è¯•
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ğŸ è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: ğŸ“¦ å®‰è£…ç³»ç»Ÿä¾èµ–
      run: |
        echo "ğŸ“¦ æ›´æ–°ç³»ç»ŸåŒ…..."
        sudo apt-get update
        echo "ğŸ¬ å®‰è£…FFmpeg..."
        sudo apt-get install -y ffmpeg
        echo "âœ… ç³»ç»Ÿä¾èµ–å®‰è£…å®Œæˆ"

    - name: ğŸ”§ å®‰è£…Pythonä¾èµ–
      run: |
        echo "ğŸ”§ å‡çº§pip..."
        python -m pip install --upgrade pip
        echo "ğŸ“š å®‰è£…é¡¹ç›®ä¾èµ–..."
        pip install -r requirements.txt
        echo "âœ… Pythonä¾èµ–å®‰è£…å®Œæˆ"

    - name: ğŸ“ åˆ›å»ºå¿…è¦ç›®å½•
      run: |
        echo "ğŸ“ åˆ›å»ºç›®å½•ç»“æ„..."
        mkdir -p downloads temp logs data data/cookies
        echo "âœ… ç›®å½•åˆ›å»ºå®Œæˆ"

    - name: ğŸ” è¿è¡Œä¾èµ–æ£€æŸ¥
      run: |
        echo "ğŸ” æ£€æŸ¥ç³»ç»Ÿä¾èµ–..."
        python check_dependencies.py
        echo "âœ… ä¾èµ–æ£€æŸ¥å®Œæˆ"

    - name: ğŸ§ª åŸºç¡€åŠŸèƒ½æµ‹è¯•
      if: ${{ inputs.test_type == 'basic' || inputs.test_type == 'full' }}
      run: |
        echo "ğŸ§ª è¿è¡ŒåŸºç¡€åŠŸèƒ½æµ‹è¯•..."
        
        # æµ‹è¯•Pythonæ¨¡å—å¯¼å…¥
        python -c "
        print('ğŸ” æµ‹è¯•æ¨¡å—å¯¼å…¥...')
        try:
            from app.core.database import Database
            print('âœ… æ•°æ®åº“æ¨¡å—: OK')
        except Exception as e:
            print(f'âŒ æ•°æ®åº“æ¨¡å—: {e}')
            
        try:
            from app.core.auth import AuthManager
            print('âœ… è®¤è¯æ¨¡å—: OK')
        except Exception as e:
            print(f'âŒ è®¤è¯æ¨¡å—: {e}')
            
        try:
            from app.modules.downloader.manager import DownloadManager
            print('âœ… ä¸‹è½½æ¨¡å—: OK')
        except Exception as e:
            print(f'âŒ ä¸‹è½½æ¨¡å—: {e}')
            
        try:
            from app.modules.telegram.notifier import TelegramNotifier
            print('âœ… Telegramæ¨¡å—: OK')
        except Exception as e:
            print(f'âŒ Telegramæ¨¡å—: {e}')
        
        print('ğŸ‰ æ¨¡å—å¯¼å…¥æµ‹è¯•å®Œæˆ')
        "
        
        # æµ‹è¯•æ•°æ®åº“åˆå§‹åŒ–
        python -c "
        print('ğŸ—„ï¸ æµ‹è¯•æ•°æ®åº“åˆå§‹åŒ–...')
        try:
            from app.core.database import Database
            db = Database()
            db.init_db()
            print('âœ… æ•°æ®åº“åˆå§‹åŒ–: OK')
        except Exception as e:
            print(f'âŒ æ•°æ®åº“åˆå§‹åŒ–: {e}')
        "
        
        echo "âœ… åŸºç¡€åŠŸèƒ½æµ‹è¯•å®Œæˆ"

    - name: ğŸš€ åº”ç”¨å¯åŠ¨æµ‹è¯•
      if: ${{ inputs.test_type == 'full' }}
      run: |
        echo "ğŸš€ æµ‹è¯•åº”ç”¨å¯åŠ¨..."
        
        # åå°å¯åŠ¨åº”ç”¨
        python app/main.py &
        APP_PID=$!
        
        # ç­‰å¾…å¯åŠ¨
        echo "â³ ç­‰å¾…åº”ç”¨å¯åŠ¨..."
        sleep 15
        
        # æ£€æŸ¥è¿›ç¨‹
        if ps -p $APP_PID > /dev/null; then
          echo "âœ… åº”ç”¨è¿›ç¨‹è¿è¡Œæ­£å¸¸"
        else
          echo "âŒ åº”ç”¨è¿›ç¨‹å¯åŠ¨å¤±è´¥"
          exit 1
        fi
        
        # ç®€å•å¥åº·æ£€æŸ¥
        for i in {1..5}; do
          if curl -f http://localhost:8080/ >/dev/null 2>&1; then
            echo "âœ… åº”ç”¨å“åº”æ­£å¸¸"
            break
          fi
          echo "â³ ç­‰å¾…åº”ç”¨å“åº”... ($i/5)"
          sleep 5
          if [ $i -eq 5 ]; then
            echo "âŒ åº”ç”¨å“åº”è¶…æ—¶"
            kill $APP_PID || true
            exit 1
          fi
        done
        
        # åœæ­¢åº”ç”¨
        kill $APP_PID || true
        echo "âœ… åº”ç”¨å¯åŠ¨æµ‹è¯•å®Œæˆ"

    - name: ğŸ³ Dockeræ„å»ºæµ‹è¯•
      if: ${{ inputs.test_type == 'docker' || inputs.test_type == 'full' }}
      run: |
        echo "ğŸ³ æµ‹è¯•Dockeræ„å»º..."
        
        # æ„å»ºé•œåƒ
        docker build -t yt-dlp-web-test:latest .
        echo "âœ… Dockeré•œåƒæ„å»ºå®Œæˆ"
        
        # å¯åŠ¨å®¹å™¨
        docker run -d \
          --name yt-dlp-test \
          -p 8080:8080 \
          -e SECRET_KEY=test-secret \
          yt-dlp-web-test:latest
        
        # ç­‰å¾…å®¹å™¨å¯åŠ¨
        echo "â³ ç­‰å¾…å®¹å™¨å¯åŠ¨..."
        sleep 20
        
        # æ£€æŸ¥å®¹å™¨çŠ¶æ€
        if docker ps | grep yt-dlp-test; then
          echo "âœ… å®¹å™¨å¯åŠ¨æˆåŠŸ"
        else
          echo "âŒ å®¹å™¨å¯åŠ¨å¤±è´¥"
          echo "ğŸ“‹ å®¹å™¨æ—¥å¿—:"
          docker logs yt-dlp-test
          exit 1
        fi
        
        # ç®€å•å¥åº·æ£€æŸ¥
        for i in {1..5}; do
          if curl -f http://localhost:8080/ >/dev/null 2>&1; then
            echo "âœ… å®¹å™¨æœåŠ¡å“åº”æ­£å¸¸"
            break
          fi
          echo "â³ ç­‰å¾…å®¹å™¨æœåŠ¡... ($i/5)"
          sleep 5
          if [ $i -eq 5 ]; then
            echo "âŒ å®¹å™¨æœåŠ¡å“åº”è¶…æ—¶"
            docker logs yt-dlp-test
            exit 1
          fi
        done
        
        echo "âœ… Dockeræµ‹è¯•å®Œæˆ"

    - name: ğŸ§¹ æ¸…ç†æµ‹è¯•ç¯å¢ƒ
      if: always()
      run: |
        echo "ğŸ§¹ æ¸…ç†æµ‹è¯•ç¯å¢ƒ..."
        
        # åœæ­¢å¹¶åˆ é™¤å®¹å™¨
        docker stop yt-dlp-test >/dev/null 2>&1 || true
        docker rm yt-dlp-test >/dev/null 2>&1 || true
        docker rmi yt-dlp-web-test:latest >/dev/null 2>&1 || true
        
        # æ¸…ç†æµ‹è¯•æ–‡ä»¶
        rm -rf downloads/* temp/* logs/* data/* || true
        
        echo "âœ… æ¸…ç†å®Œæˆ"

    - name: ğŸ“Š æµ‹è¯•æ€»ç»“
      if: always()
      run: |
        echo "ğŸ“Š æµ‹è¯•æ€»ç»“"
        echo "===================="
        echo "ğŸ§ª æµ‹è¯•ç±»å‹: ${{ inputs.test_type }}"
        echo "ğŸ Pythonç‰ˆæœ¬: $(python --version)"
        echo "ğŸ¬ FFmpegç‰ˆæœ¬: $(ffmpeg -version 2>&1 | head -n1)"
        echo "ğŸ³ Dockerç‰ˆæœ¬: $(docker --version)"
        echo "â° æµ‹è¯•æ—¶é—´: $(date)"
        echo "===================="
        
        if [ "${{ job.status }}" == "success" ]; then
          echo "ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼"
        else
          echo "âŒ éƒ¨åˆ†æµ‹è¯•å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ—¥å¿—"
        fi

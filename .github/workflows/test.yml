name: ä»£ç æµ‹è¯•

on:
  workflow_dispatch:
    inputs:
      python_versions:
        description: 'Pythonç‰ˆæœ¬'
        required: true
        default: '["3.11"]'
        type: choice
        options:
        - '["3.9"]'
        - '["3.10"]'
        - '["3.11"]'
        - '["3.12"]'
        - '["3.9", "3.10", "3.11", "3.12"]'
      run_lint:
        description: 'æ˜¯å¦è¿è¡Œä»£ç æ£€æŸ¥'
        required: true
        default: true
        type: boolean

jobs:
  test:
    name: ğŸ§ª Pythonæµ‹è¯•
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ${{ fromJSON(inputs.python_versions) }}

    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç ä»“åº“
      uses: actions/checkout@v4

    - name: ğŸ è®¾ç½®Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: ğŸ“¦ å®‰è£…ç³»ç»Ÿä¾èµ–
      run: |
        echo "ğŸ“¦ æ›´æ–°ç³»ç»ŸåŒ…..."
        sudo apt-get update
        echo "ğŸ¬ å®‰è£…FFmpeg..."
        sudo apt-get install -y ffmpeg
        echo "âœ… ç³»ç»Ÿä¾èµ–å®‰è£…å®Œæˆ"

    - name: ğŸ”§ å®‰è£…Pythonä¾èµ–
      run: |
        echo "ğŸ”§ å‡çº§pip..."
        python -m pip install --upgrade pip
        echo "ğŸ“š å®‰è£…é¡¹ç›®ä¾èµ–..."
        pip install -r requirements.txt
        echo "ğŸ§ª å®‰è£…æµ‹è¯•ä¾èµ–..."
        pip install pytest pytest-cov pytest-asyncio
        echo "âœ… Pythonä¾èµ–å®‰è£…å®Œæˆ"

    - name: ğŸ“ åˆ›å»ºæµ‹è¯•ç›®å½•
      run: |
        echo "ğŸ“ åˆ›å»ºå¿…è¦ç›®å½•..."
        mkdir -p downloads temp logs data
        echo "âœ… æµ‹è¯•ç›®å½•åˆ›å»ºå®Œæˆ"

    - name: ğŸ§ª è¿è¡Œæµ‹è¯•
      run: |
        echo "ğŸ§ª å¼€å§‹è¿è¡Œæµ‹è¯•..."
        pytest tests/ -v --cov=app --cov-report=term-missing --cov-report=xml
        echo "âœ… æµ‹è¯•è¿è¡Œå®Œæˆ"

    - name: ğŸ“Š ä¸Šä¼ è¦†ç›–ç‡æŠ¥å‘Š
      if: matrix.python-version == '3.11'
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella

  lint:
    name: ğŸ” ä»£ç è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest
    if: ${{ inputs.run_lint }}

    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç ä»“åº“
      uses: actions/checkout@v4

    - name: ğŸ è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: ğŸ”§ å®‰è£…æ£€æŸ¥å·¥å…·
      run: |
        echo "ğŸ”§ å‡çº§pip..."
        python -m pip install --upgrade pip
        echo "ğŸ› ï¸ å®‰è£…ä»£ç æ£€æŸ¥å·¥å…·..."
        pip install flake8 black isort
        echo "âœ… æ£€æŸ¥å·¥å…·å®‰è£…å®Œæˆ"

    - name: ğŸ” Flake8è¯­æ³•æ£€æŸ¥
      run: |
        echo "ğŸ” è¿è¡ŒFlake8è¯­æ³•æ£€æŸ¥..."
        echo "âŒ æ£€æŸ¥ä¸¥é‡é”™è¯¯..."
        flake8 app/ --count --select=E9,F63,F7,F82 --show-source --statistics
        echo "âš ï¸ æ£€æŸ¥ä»£ç è´¨é‡..."
        flake8 app/ --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
        echo "âœ… Flake8æ£€æŸ¥å®Œæˆ"

    - name: ğŸ¨ Blackä»£ç æ ¼å¼æ£€æŸ¥
      run: |
        echo "ğŸ¨ æ£€æŸ¥ä»£ç æ ¼å¼..."
        black --check app/
        echo "âœ… ä»£ç æ ¼å¼æ£€æŸ¥é€šè¿‡"

    - name: ğŸ“¦ Importæ’åºæ£€æŸ¥
      run: |
        echo "ğŸ“¦ æ£€æŸ¥importæ’åº..."
        isort --check-only app/
        echo "âœ… Importæ’åºæ£€æŸ¥é€šè¿‡"

    - name: ğŸ“Š è¾“å‡ºæ£€æŸ¥æ‘˜è¦
      run: |
        echo "ğŸ‰ æ‰€æœ‰ä»£ç è´¨é‡æ£€æŸ¥é€šè¿‡ï¼"
        echo "âœ… è¯­æ³•æ£€æŸ¥: é€šè¿‡"
        echo "âœ… æ ¼å¼æ£€æŸ¥: é€šè¿‡"
        echo "âœ… æ’åºæ£€æŸ¥: é€šè¿‡"

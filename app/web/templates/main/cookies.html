{% extends "base.html" %}

{% block title %}Cookies管理 - YT-DLP Web V2{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-6" x-data="cookiesApp()">
    
    <!-- 页面标题 -->
    <div class="mb-6">
        <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Cookies管理</h1>
        <p class="text-gray-600 dark:text-gray-400 mt-1">管理网站Cookies以访问需要登录的内容</p>
    </div>
    
    <!-- 上传Cookies -->
    <div class="card p-6 mb-6">
        <h2 class="text-lg font-semibold mb-4 flex items-center">
            <i data-feather="upload" class="w-5 h-5 mr-2"></i>
            上传Cookies文件
        </h2>
        
        <div class="space-y-4">
            <!-- 网站选择 -->
            <div>
                <label class="block text-sm font-medium mb-2">目标网站</label>
                <select x-model="uploadForm.website" class="input-field">
                    <option value="">选择网站</option>
                    <option value="youtube">YouTube</option>
                    <option value="bilibili">Bilibili</option>
                    <option value="twitter">Twitter/X</option>
                    <option value="instagram">Instagram</option>
                    <option value="tiktok">TikTok</option>
                    <option value="custom">自定义</option>
                </select>
            </div>
            
            <!-- 自定义网站名 -->
            <div x-show="uploadForm.website === 'custom'">
                <label class="block text-sm font-medium mb-2">自定义网站名</label>
                <input type="text" x-model="uploadForm.customWebsite" class="input-field" 
                       placeholder="例如: example.com">
            </div>
            
            <!-- 文件上传方式选择 -->
            <div>
                <label class="block text-sm font-medium mb-2">上传方式</label>
                <div class="flex space-x-4">
                    <label class="flex items-center">
                        <input type="radio" x-model="uploadForm.method" value="file" 
                               class="mr-2" checked>
                        <span>文件上传</span>
                    </label>
                    <label class="flex items-center">
                        <input type="radio" x-model="uploadForm.method" value="text" 
                               class="mr-2">
                        <span>文本粘贴</span>
                    </label>
                </div>
            </div>
            
            <!-- 文件上传 -->
            <div x-show="uploadForm.method === 'file'">
                <label class="block text-sm font-medium mb-2">Cookies文件</label>
                <div class="border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-6 text-center"
                     @dragover.prevent @drop.prevent="handleFileDrop($event)">
                    <input type="file" @change="handleFileSelect($event)" 
                           accept=".txt,.json" class="hidden" x-ref="fileInput">
                    <div x-show="!uploadForm.file">
                        <i data-feather="upload-cloud" class="w-12 h-12 mx-auto mb-2 text-gray-400"></i>
                        <p class="text-gray-600 dark:text-gray-400 mb-2">
                            拖拽文件到此处或 
                            <button type="button" @click="$refs.fileInput.click()" 
                                    class="text-blue-600 dark:text-blue-400 hover:underline">
                                点击选择文件
                            </button>
                        </p>
                        <p class="text-xs text-gray-500">支持 .txt 和 .json 格式</p>
                    </div>
                    <div x-show="uploadForm.file" class="flex items-center justify-center">
                        <i data-feather="file" class="w-6 h-6 mr-2 text-green-600"></i>
                        <span x-text="uploadForm.file?.name"></span>
                        <button type="button" @click="clearFile()" 
                                class="ml-2 text-red-600 hover:text-red-800">
                            <i data-feather="x" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- 文本粘贴 -->
            <div x-show="uploadForm.method === 'text'">
                <label class="block text-sm font-medium mb-2">Cookies内容</label>
                <textarea x-model="uploadForm.content" 
                          class="input-field h-32" 
                          placeholder="粘贴Cookies内容...&#10;支持Netscape格式或JSON格式"></textarea>
            </div>
            
            <!-- 格式说明 -->
            <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4">
                <h3 class="font-medium text-blue-900 dark:text-blue-300 mb-2">支持的格式</h3>
                <ul class="text-sm text-blue-800 dark:text-blue-400 space-y-1">
                    <li>• <strong>Netscape格式</strong>: 浏览器导出的标准格式</li>
                    <li>• <strong>JSON格式</strong>: 开发者工具导出的格式</li>
                    <li>• <strong>自动检测</strong>: 系统会自动识别格式并转换</li>
                </ul>
            </div>
            
            <!-- 上传按钮 -->
            <button @click="uploadCookies()" 
                    :disabled="!canUpload()" 
                    class="btn-primary">
                <i data-feather="upload" class="w-4 h-4 mr-2"></i>
                上传Cookies
            </button>
        </div>
    </div>
    
    <!-- 已保存的Cookies -->
    <div class="card p-6">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-semibold flex items-center">
                <i data-feather="database" class="w-5 h-5 mr-2"></i>
                已保存的Cookies
            </h2>
            <button @click="refreshCookies()" class="btn-secondary">
                <i data-feather="refresh-cw" class="w-4 h-4 mr-2"></i>
                刷新
            </button>
        </div>
        
        <div x-show="cookies.length === 0" class="text-center py-8 text-gray-500 dark:text-gray-400">
            <i data-feather="cookie" class="w-12 h-12 mx-auto mb-2 opacity-50"></i>
            <p>暂无保存的Cookies</p>
        </div>
        
        <div x-show="cookies.length > 0" class="space-y-4">
            <template x-for="cookie in cookies" :key="cookie.id">
                <div class="border border-gray-200 dark:border-gray-600 rounded-lg p-4">
                    <div class="flex items-center justify-between">
                        <div class="flex-1">
                            <div class="flex items-center space-x-3">
                                <div class="w-8 h-8 rounded-full flex items-center justify-center text-sm font-medium"
                                     :class="getWebsiteColor(cookie.website)">
                                    <span x-text="cookie.website.charAt(0).toUpperCase()"></span>
                                </div>
                                <div>
                                    <h3 class="font-medium text-gray-900 dark:text-white" 
                                        x-text="getWebsiteName(cookie.website)"></h3>
                                    <p class="text-sm text-gray-600 dark:text-gray-400">
                                        <span x-text="cookie.count"></span> 个Cookie
                                        • 上传于 <span x-text="formatDate(cookie.created_at)"></span>
                                    </p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex items-center space-x-2">
                            <!-- 格式标签 -->
                            <span class="px-2 py-1 text-xs rounded bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300">
                                <span x-text="cookie.format || 'auto'"></span>
                            </span>

                            <!-- 测试按钮 -->
                            <button @click="testCookies(cookie.website)"
                                    class="text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300"
                                    title="测试有效性">
                                <i data-feather="check-circle" class="w-4 h-4"></i>
                            </button>

                            <!-- 下载按钮 -->
                            <button @click="downloadCookies(cookie.website)"
                                    class="text-green-600 dark:text-green-400 hover:text-green-800 dark:hover:text-green-300"
                                    title="导出Cookies">
                                <i data-feather="download" class="w-4 h-4"></i>
                            </button>

                            <!-- 删除按钮 -->
                            <button @click="deleteCookies(cookie.website)"
                                    class="text-red-600 dark:text-red-400 hover:text-red-800 dark:hover:text-red-300"
                                    title="删除Cookies">
                                <i data-feather="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- 详细信息 -->
                    <div x-show="cookie.showDetails" class="mt-4 pt-4 border-t border-gray-200 dark:border-gray-600">
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div>
                                <span class="font-medium">文件大小:</span>
                                <span x-text="formatFileSize(cookie.file_size)"></span>
                            </div>
                            <div>
                                <span class="font-medium">最后更新:</span>
                                <span x-text="formatDate(cookie.updated_at)"></span>
                            </div>
                            <div>
                                <span class="font-medium">格式类型:</span>
                                <span x-text="cookie.format"></span>
                            </div>
                            <div>
                                <span class="font-medium">Cookie数量:</span>
                                <span x-text="cookie.count"></span>
                            </div>
                        </div>
                    </div>
                    
                    <button @click="cookie.showDetails = !cookie.showDetails" 
                            class="mt-2 text-xs text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300">
                        <span x-text="cookie.showDetails ? '收起详情' : '显示详情'"></span>
                    </button>
                </div>
            </template>
        </div>
    </div>
    
</div>
{% endblock %}

{% block extra_scripts %}
<script>
function cookiesApp() {
    return {
        uploadForm: {
            website: '',
            customWebsite: '',
            method: 'file',
            file: null,
            content: ''
        },
        cookies: [],
        
        async init() {
            await this.loadCookies();
        },
        
        handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                this.uploadForm.file = file;
            }
        },
        
        handleFileDrop(event) {
            const file = event.dataTransfer.files[0];
            if (file) {
                this.uploadForm.file = file;
            }
        },
        
        clearFile() {
            this.uploadForm.file = null;
            this.$refs.fileInput.value = '';
        },
        
        canUpload() {
            const hasWebsite = this.uploadForm.website && 
                              (this.uploadForm.website !== 'custom' || this.uploadForm.customWebsite);
            const hasContent = this.uploadForm.method === 'file' ? 
                              this.uploadForm.file : 
                              this.uploadForm.content.trim();
            return hasWebsite && hasContent;
        },
        
        async uploadCookies() {
            if (!this.canUpload()) return;
            
            try {
                const formData = new FormData();
                formData.append('website', this.uploadForm.website === 'custom' ? 
                               this.uploadForm.customWebsite : this.uploadForm.website);
                
                if (this.uploadForm.method === 'file') {
                    formData.append('file', this.uploadForm.file);
                } else {
                    formData.append('content', this.uploadForm.content);
                }
                
                const response = await apiRequest('/cookies/api/upload', {
                    method: 'POST',
                    body: formData,
                    headers: {} // 让浏览器自动设置Content-Type
                });
                
                if (response.ok) {
                    showNotification('Cookies上传成功', 'success');
                    this.resetForm();
                    await this.loadCookies();
                } else {
                    const data = await response.json();
                    showNotification(data.error || 'Cookies上传失败', 'error');
                }
            } catch (error) {
                showNotification('网络错误', 'error');
            }
        },
        
        async loadCookies() {
            try {
                const response = await apiRequest('/cookies/api/list');
                if (response.ok) {
                    const data = await response.json();
                    this.cookies = data.cookies.map(cookie => ({
                        ...cookie,
                        showDetails: false
                    }));
                }
            } catch (error) {
                console.error('加载Cookies失败:', error);
            }
        },
        
        async testCookies(website) {
            try {
                const response = await apiRequest(`/cookies/api/test/${website}`, {
                    method: 'POST'
                });

                if (response.ok) {
                    const data = await response.json();
                    const message = `测试完成: ${data.valid_cookies}/${data.total_cookies} 个有效`;
                    showNotification(message, data.valid_cookies > 0 ? 'success' : 'warning');
                    await this.loadCookies();
                } else {
                    showNotification('测试失败', 'error');
                }
            } catch (error) {
                showNotification('网络错误', 'error');
            }
        },

        downloadCookies(website, format = 'netscape') {
            window.open(`/cookies/api/export/${website}?format=${format}`, '_blank');
        },

        async deleteCookies(website) {
            if (!confirm('确定要删除这个Cookies吗？')) return;

            try {
                const response = await apiRequest(`/cookies/api/delete/${website}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showNotification('Cookies删除成功', 'success');
                    await this.loadCookies();
                } else {
                    showNotification('删除失败', 'error');
                }
            } catch (error) {
                showNotification('网络错误', 'error');
            }
        },
        
        async refreshCookies() {
            await this.loadCookies();
            showNotification('列表已刷新', 'success');
        },
        
        resetForm() {
            this.uploadForm = {
                website: '',
                customWebsite: '',
                method: 'file',
                file: null,
                content: ''
            };
            this.$refs.fileInput.value = '';
        },
        
        getWebsiteName(website) {
            const names = {
                'youtube': 'YouTube',
                'bilibili': 'Bilibili',
                'twitter': 'Twitter/X',
                'instagram': 'Instagram',
                'tiktok': 'TikTok'
            };
            return names[website] || website;
        },
        
        getWebsiteColor(website) {
            const colors = {
                'youtube': 'bg-red-500 text-white',
                'bilibili': 'bg-pink-500 text-white',
                'twitter': 'bg-blue-500 text-white',
                'instagram': 'bg-purple-500 text-white',
                'tiktok': 'bg-black text-white'
            };
            return colors[website] || 'bg-gray-500 text-white';
        },
        
        formatDate(dateString) {
            if (!dateString) return '未知';
            return new Date(dateString).toLocaleString('zh-CN');
        },

        formatFileSize(bytes) {
            if (!bytes) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
    }
}
</script>
{% endblock %}

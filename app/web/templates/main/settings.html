{% extends "base.html" %}

{% block title %}系统设置 - YT-DLP Web V2{% endblock %}

{% block content %}
<div class="container-fluid" id="settingsApp">

    <!-- 页面标题 -->
    <div class="row mb-4">
        <div class="col">
            <h1 class="h2 mb-1">系统设置</h1>
            <p class="text-muted">配置应用的全局设置</p>
        </div>
    </div>

    <!-- 设置选项卡 -->
    <div class="row mb-4">
        <div class="col">
            <ul class="nav nav-tabs" id="settingsTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="general-tab" data-bs-toggle="tab" data-bs-target="#general" type="button" role="tab">
                        <i class="bi bi-gear me-2"></i>基础设置
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="download-tab" data-bs-toggle="tab" data-bs-target="#download" type="button" role="tab">
                        <i class="bi bi-download me-2"></i>下载配置
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="security-tab" data-bs-toggle="tab" data-bs-target="#security" type="button" role="tab">
                        <i class="bi bi-shield me-2"></i>安全设置
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="shortcuts-tab" data-bs-toggle="tab" data-bs-target="#shortcuts" type="button" role="tab">
                        <i class="bi bi-phone me-2"></i>iOS快捷指令
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="advanced-tab" data-bs-toggle="tab" data-bs-target="#advanced" type="button" role="tab">
                        <i class="bi bi-lightning me-2"></i>高级功能
                    </button>
                </li>
            </ul>
        </div>
    </div>

    <!-- 选项卡内容 -->
    <div class="tab-content" id="settingsTabContent">

        <!-- 基础设置 -->
        <div class="tab-pane fade show active" id="general" role="tabpanel">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="bi bi-gear me-2"></i>基础设置
                    </h5>

                    <form id="generalForm">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="appName" class="form-label">应用名称</label>
                                <input type="text" class="form-control" id="appName" value="YT-DLP Web V2">
                            </div>

                            <div class="col-md-6">
                                <label for="sessionTimeout" class="form-label">会话超时 (小时)</label>
                                <input type="number" class="form-control" id="sessionTimeout" value="24" min="1" max="168">
                            </div>

                            <div class="col-12">
                                <label for="secretKey" class="form-label">应用密钥</label>
                                <div class="input-group">
                                    <input type="password" class="form-control" id="secretKey" placeholder="点击生成新密钥">
                                    <button type="button" class="btn btn-outline-secondary" id="toggleSecretKey">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" id="generateSecretKey">
                                        生成新密钥
                                    </button>
                                </div>
                                <div class="form-text">用于会话加密，修改后所有用户需要重新登录</div>
                            </div>

                            <div class="col-12">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="debugMode">
                                    <label class="form-check-label" for="debugMode">
                                        启用调试模式
                                    </label>
                                </div>
                            </div>

                            <div class="col-12">
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-check-lg me-2"></i>保存基础设置
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- 下载配置 -->
        <div class="tab-pane fade" id="download" role="tabpanel">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="bi bi-download me-2"></i>下载配置
                    </h5>

                    <form id="downloadForm">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="outputDir" class="form-label">下载目录</label>
                                <input type="text" class="form-control" id="outputDir" value="/downloads">
                            </div>

                            <div class="col-md-6">
                                <label for="maxConcurrent" class="form-label">最大并发下载数</label>
                                <input type="number" class="form-control" id="maxConcurrent" value="3" min="1" max="10">
                            </div>

                            <div class="col-md-6">
                                <label for="downloadTimeout" class="form-label">下载超时 (秒)</label>
                                <input type="number" class="form-control" id="downloadTimeout" value="300" min="60" max="3600">
                            </div>

                            <div class="col-md-6">
                                <label for="defaultQuality" class="form-label">默认视频质量</label>
                                <select class="form-select" id="defaultQuality">
                                    <option value="best">最高质量</option>
                                    <option value="medium" selected>中等质量 (720p)</option>
                                    <option value="low">低质量</option>
                                </select>
                            </div>

                            <div class="col-12">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="autoCleanup">
                                    <label class="form-check-label" for="autoCleanup">
                                        启用自动清理
                                    </label>
                                </div>
                            </div>

                            <div class="col-12" id="cleanupOptions" style="display: none;">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h6 class="card-title">自动清理选项</h6>
                                        <div class="row g-3">
                                            <div class="col-md-6">
                                                <label for="fileRetention" class="form-label">文件保留时间 (小时)</label>
                                                <input type="number" class="form-control" id="fileRetention" value="72" min="1" max="8760">
                                            </div>

                                            <div class="col-md-6">
                                                <label for="cleanupInterval" class="form-label">清理间隔 (小时)</label>
                                                <input type="number" class="form-control" id="cleanupInterval" value="6" min="1" max="168">
                                            </div>

                                            <div class="col-md-6">
                                                <label for="maxStorage" class="form-label">最大存储空间 (MB)</label>
                                                <input type="number" class="form-control" id="maxStorage" value="5000" min="100">
                                            </div>

                                            <div class="col-md-6">
                                                <label for="keepRecentFiles" class="form-label">保留最近文件数</label>
                                                <input type="number" class="form-control" id="keepRecentFiles" value="10" min="1" max="100">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="col-12">
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-check-lg me-2"></i>保存下载配置
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- 安全设置 -->
        <div class="tab-pane fade" id="security" role="tabpanel">
            <div class="row g-4">
                <!-- 修改密码 -->
                <div class="col-12">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">
                                <i class="bi bi-key me-2"></i>修改管理员密码
                            </h5>

                            <form id="passwordForm">
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <label for="currentPassword" class="form-label">当前密码</label>
                                        <input type="password" class="form-control" id="currentPassword" required>
                                    </div>

                                    <div class="col-md-4">
                                        <label for="newPassword" class="form-label">新密码</label>
                                        <input type="password" class="form-control" id="newPassword" minlength="6" required>
                                    </div>

                                    <div class="col-md-4">
                                        <label for="confirmPassword" class="form-label">确认新密码</label>
                                        <input type="password" class="form-control" id="confirmPassword" required>
                                    </div>

                                    <div class="col-12">
                                        <button type="submit" class="btn btn-primary">
                                            <i class="bi bi-key me-2"></i>修改密码
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- API访问控制 -->
                <div class="col-12">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">
                                <i class="bi bi-shield-check me-2"></i>API访问控制
                            </h5>

                            <form id="apiForm">
                                <div class="row g-3">
                                    <div class="col-12">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="apiEnabled">
                                            <label class="form-check-label" for="apiEnabled">
                                                启用API访问
                                            </label>
                                        </div>
                                    </div>

                                    <div class="col-12" id="apiKeySection" style="display: none;">
                                        <label for="apiKey" class="form-label">API密钥</label>
                                        <div class="input-group">
                                            <input type="text" class="form-control" id="apiKey" readonly>
                                            <button type="button" class="btn btn-outline-secondary" id="generateApiKey">
                                                重新生成
                                            </button>
                                        </div>

                                        <div class="alert alert-info mt-3">
                                            <i class="bi bi-info-circle me-2"></i>
                                            此API密钥可用于iOS快捷指令等第三方应用访问下载服务
                                        </div>
                                    </div>

                                    <div class="col-12">
                                        <button type="submit" class="btn btn-primary">
                                            <i class="bi bi-check-lg me-2"></i>保存API设置
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- iOS快捷指令 -->
        <div class="tab-pane fade" id="shortcuts" role="tabpanel">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="bi bi-phone me-2"></i>iOS快捷指令集成
                    </h5>

                    <!-- 服务状态 -->
                    <div class="alert alert-success mb-4">
                        <div class="d-flex">
                            <i class="bi bi-check-circle me-3 mt-1"></i>
                            <div>
                                <h6 class="alert-heading">iOS快捷指令API已就绪</h6>
                                <p class="mb-0">您可以使用以下信息配置iOS快捷指令来下载视频</p>
                            </div>
                        </div>
                    </div>

                    <!-- API配置信息 -->
                    <div class="mb-4">
                        <h6 class="mb-3">API配置信息</h6>

                        <div class="row g-3">
                            <div class="col-12">
                                <label class="form-label">服务器地址</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="serverUrl" readonly>
                                    <button type="button" class="btn btn-outline-secondary" onclick="copyToClipboard('serverUrl')">
                                        <i class="bi bi-clipboard"></i>
                                    </button>
                                </div>
                            </div>

                            <div class="col-12">
                                <label class="form-label">下载API端点</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="downloadEndpoint" readonly>
                                    <button type="button" class="btn btn-outline-secondary" onclick="copyToClipboard('downloadEndpoint')">
                                        <i class="bi bi-clipboard"></i>
                                    </button>
                                </div>
                            </div>

                            <div class="col-12" id="apiKeySection2" style="display: none;">
                                <label class="form-label">API密钥</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="apiKeyDisplay" readonly>
                                    <button type="button" class="btn btn-outline-secondary" onclick="copyToClipboard('apiKeyDisplay')">
                                        <i class="bi bi-clipboard"></i>
                                    </button>
                                </div>
                                <div class="form-text">在快捷指令中使用此API密钥进行认证</div>
                            </div>

                            <div class="col-12" id="apiKeyWarning2">
                                <div class="alert alert-warning">
                                    <i class="bi bi-exclamation-triangle me-2"></i>
                                    请先在"安全设置"中启用API访问并生成API密钥
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 快捷指令模板 -->
                    <div class="border-top pt-4 mb-4">
                        <h6 class="mb-3">快捷指令配置模板</h6>

                        <div class="row g-3">
                            <!-- 基础下载模板 -->
                            <div class="col-md-6">
                                <div class="card h-100">
                                    <div class="card-body">
                                        <h6 class="card-title">
                                            <i class="bi bi-download me-2"></i>基础下载快捷指令
                                        </h6>
                                        <p class="card-text small text-muted">
                                            从剪贴板获取URL并下载视频到文件应用
                                        </p>

                                        <div class="bg-light rounded p-3 mb-3">
                                            <div class="small">
                                                <div>1. 获取剪贴板</div>
                                                <div>2. 获取URL内容 (POST)</div>
                                                <div class="ms-3 text-primary">URL: /api/shortcuts/download</div>
                                                <div class="ms-3">JSON: {"url": "[剪贴板]", "api_key": "your_key"}</div>
                                                <div>3. 等待下载完成</div>
                                                <div>4. 保存文件到iCloud Drive</div>
                                            </div>
                                        </div>

                                        <button type="button" class="btn btn-primary btn-sm" onclick="downloadShortcutTemplate('basic')">
                                            <i class="bi bi-download me-2"></i>下载配置文件
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- 高级下载模板 -->
                            <div class="col-md-6">
                                <div class="card h-100">
                                    <div class="card-body">
                                        <h6 class="card-title">
                                            <i class="bi bi-gear me-2"></i>高级下载快捷指令
                                        </h6>
                                        <p class="card-text small text-muted">
                                            支持质量选择、进度显示和错误处理
                                        </p>

                                        <div class="bg-light rounded p-3 mb-3">
                                            <div class="small">
                                                <div>1. 获取剪贴板内容</div>
                                                <div>2. 选择视频质量 (最高/中等/低)</div>
                                                <div>3. 选择下载类型 (视频/音频)</div>
                                                <div>4. 发送下载请求</div>
                                                <div>5. 显示进度通知</div>
                                                <div>6. 下载完成后保存文件</div>
                                            </div>
                                        </div>

                                        <button type="button" class="btn btn-primary btn-sm" onclick="downloadShortcutTemplate('advanced')">
                                            <i class="bi bi-download me-2"></i>下载配置文件
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 使用说明 -->
                    <div class="border-top pt-4">
                        <h6 class="mb-3">使用说明</h6>

                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="d-flex">
                                    <span class="badge bg-primary rounded-circle me-3 mt-1" style="width: 24px; height: 24px; display: flex; align-items: center; justify-content: center;">1</span>
                                    <div>
                                        <h6 class="mb-1">配置API访问</h6>
                                        <p class="text-muted small mb-0">在"安全设置"中启用API访问并生成API密钥</p>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="d-flex">
                                    <span class="badge bg-primary rounded-circle me-3 mt-1" style="width: 24px; height: 24px; display: flex; align-items: center; justify-content: center;">2</span>
                                    <div>
                                        <h6 class="mb-1">创建快捷指令</h6>
                                        <p class="text-muted small mb-0">在iOS"快捷指令"应用中创建新的快捷指令</p>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="d-flex">
                                    <span class="badge bg-primary rounded-circle me-3 mt-1" style="width: 24px; height: 24px; display: flex; align-items: center; justify-content: center;">3</span>
                                    <div>
                                        <h6 class="mb-1">配置API调用</h6>
                                        <p class="text-muted small mb-0">使用上面的API端点和密钥配置HTTP请求</p>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="d-flex">
                                    <span class="badge bg-primary rounded-circle me-3 mt-1" style="width: 24px; height: 24px; display: flex; align-items: center; justify-content: center;">4</span>
                                    <div>
                                        <h6 class="mb-1">测试使用</h6>
                                        <p class="text-muted small mb-0">复制视频链接到剪贴板，运行快捷指令测试</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="alert alert-info mt-3">
                            <i class="bi bi-info-circle me-2"></i>
                            详细配置教程请参考项目文档中的"iOS快捷指令集成指南"
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 高级功能 -->
        <div class="tab-pane fade" id="advanced" role="tabpanel">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="bi bi-lightning me-2"></i>高级功能
                    </h5>

                    <!-- yt-dlp管理 -->
                    <div class="mb-4">
                        <h6>yt-dlp 管理</h6>
                        <div class="alert alert-info">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>当前版本</strong>
                                    <div class="small" id="ytdlpVersion">检测中...</div>
                                </div>
                                <div class="btn-group">
                                    <button type="button" class="btn btn-outline-secondary btn-sm" id="checkYtdlpInfo">
                                        <i class="bi bi-info-circle"></i> 检查信息
                                    </button>
                                    <button type="button" class="btn btn-primary btn-sm" id="updateYtdlp">
                                        <i class="bi bi-download"></i> 更新yt-dlp
                                    </button>
                                    <button type="button" class="btn btn-warning btn-sm" id="installYtdlp">
                                        <i class="bi bi-box"></i> 重新安装
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 系统信息 -->
                    <div class="mb-4">
                        <h6>系统信息</h6>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h6 class="card-title">存储空间</h6>
                                        <div id="storageInfo">
                                            <div class="d-flex justify-content-between">
                                                <span>已用空间:</span>
                                                <span id="usedSpace">计算中...</span>
                                            </div>
                                            <div class="d-flex justify-content-between">
                                                <span>可用空间:</span>
                                                <span id="freeSpace">计算中...</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h6 class="card-title">运行状态</h6>
                                        <div id="systemStatus">
                                            <div class="d-flex justify-content-between">
                                                <span>运行时间:</span>
                                                <span id="uptime">计算中...</span>
                                            </div>
                                            <div class="d-flex justify-content-between">
                                                <span>活跃下载:</span>
                                                <span id="activeDownloads">0</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 维护操作 -->
                    <div>
                        <h6>维护操作</h6>
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-outline-warning" id="cleanupFiles">
                                <i class="bi bi-trash"></i> 清理文件
                            </button>
                            <button type="button" class="btn btn-outline-info" id="refreshSystem">
                                <i class="bi bi-arrow-clockwise"></i> 刷新系统
                            </button>
                            <button type="button" class="btn btn-outline-danger" id="restartService">
                                <i class="bi bi-power"></i> 重启服务
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

</div>
{% endblock %}

{% block extra_scripts %}
<script>
class SettingsApp {
    constructor() {
        this.settings = {
            general: {
                app_name: 'YT-DLP Web V2',
                session_timeout: 24,
                secret_key: '',
                debug_mode: false
            },
            download: {
                output_dir: '/downloads',
                max_concurrent: 3,
                timeout: 300,
                default_quality: 'medium',
                auto_cleanup: false,
                file_retention_hours: 72,
                cleanup_interval: 6,
                max_storage_mb: 5000,
                keep_recent_files: 10
            },
            security: {
                api_enabled: false,
                api_key: ''
            }
        };

        this.init();
    }

    init() {
        this.bindEvents();
        this.loadSettings();
        this.checkSystemInfo();
        this.updateShortcutInfo();
    }

    bindEvents() {
        // 基础设置表单
        document.getElementById('generalForm').addEventListener('submit', (e) => {
            e.preventDefault();
            this.saveGeneralSettings();
        });

        // 下载配置表单
        document.getElementById('downloadForm').addEventListener('submit', (e) => {
            e.preventDefault();
            this.saveDownloadSettings();
        });

        // 密码修改表单
        document.getElementById('passwordForm').addEventListener('submit', (e) => {
            e.preventDefault();
            this.changePassword();
        });

        // API设置表单
        document.getElementById('apiForm').addEventListener('submit', (e) => {
            e.preventDefault();
            this.saveApiSettings();
        });

        // 密钥显示/隐藏
        document.getElementById('toggleSecretKey').addEventListener('click', () => {
            this.toggleSecretKeyVisibility();
        });

        // 生成密钥
        document.getElementById('generateSecretKey').addEventListener('click', () => {
            this.generateSecretKey();
        });

        // 自动清理选项
        document.getElementById('autoCleanup').addEventListener('change', (e) => {
            this.toggleCleanupOptions(e.target.checked);
        });

        // API启用选项
        document.getElementById('apiEnabled').addEventListener('change', (e) => {
            this.toggleApiKeySection(e.target.checked);
        });

        // 生成API密钥
        document.getElementById('generateApiKey').addEventListener('click', () => {
            this.generateApiKey();
        });

        // yt-dlp管理
        document.getElementById('checkYtdlpInfo').addEventListener('click', () => {
            this.checkYtdlpInfo();
        });

        document.getElementById('updateYtdlp').addEventListener('click', () => {
            this.updateYtdlp();
        });

        document.getElementById('installYtdlp').addEventListener('click', () => {
            this.installYtdlp();
        });

        // 维护操作
        document.getElementById('cleanupFiles').addEventListener('click', () => {
            this.cleanupFiles();
        });

        document.getElementById('refreshSystem').addEventListener('click', () => {
            this.refreshSystem();
        });

        document.getElementById('restartService').addEventListener('click', () => {
            this.restartService();
        });
    }

    async loadSettings() {
        try {
            // 加载基础设置
            const generalResponse = await apiRequest('/api/settings/general');
            if (generalResponse.ok) {
                const generalData = await generalResponse.json();
                if (generalData.success) {
                    this.settings.general = { ...this.settings.general, ...generalData.settings };
                }
            }

            // 加载下载设置
            const downloadResponse = await apiRequest('/api/settings/download');
            if (downloadResponse.ok) {
                const downloadData = await downloadResponse.json();
                if (downloadData.success) {
                    this.settings.download = { ...this.settings.download, ...downloadData.settings };
                }
            }

            // 加载API密钥设置
            const apiKeyResponse = await apiRequest('/api/settings/api-key');
            if (apiKeyResponse.ok) {
                const apiKeyData = await apiKeyResponse.json();
                if (apiKeyData.success) {
                    this.settings.security.api_key = apiKeyData.api_key;
                    this.settings.security.api_enabled = apiKeyData.has_key;
                }
            }

            this.updateUI();
        } catch (error) {
            console.error('加载设置失败:', error);
        }
    }

    updateUI() {
        // 更新基础设置
        document.getElementById('appName').value = this.settings.general.app_name;
        document.getElementById('sessionTimeout').value = this.settings.general.session_timeout;
        document.getElementById('secretKey').value = this.settings.general.secret_key;
        document.getElementById('debugMode').checked = this.settings.general.debug_mode;

        // 更新下载配置
        document.getElementById('outputDir').value = this.settings.download.output_dir;
        document.getElementById('maxConcurrent').value = this.settings.download.max_concurrent;
        document.getElementById('downloadTimeout').value = this.settings.download.timeout;
        document.getElementById('defaultQuality').value = this.settings.download.default_quality;
        document.getElementById('autoCleanup').checked = this.settings.download.auto_cleanup;
        document.getElementById('fileRetention').value = this.settings.download.file_retention_hours;
        document.getElementById('cleanupInterval').value = this.settings.download.cleanup_interval;
        document.getElementById('maxStorage').value = this.settings.download.max_storage_mb;
        document.getElementById('keepRecentFiles').value = this.settings.download.keep_recent_files;

        // 更新安全设置
        document.getElementById('apiEnabled').checked = this.settings.security.api_enabled;
        document.getElementById('apiKey').value = this.settings.security.api_key;

        // 更新UI状态
        this.toggleCleanupOptions(this.settings.download.auto_cleanup);
        this.toggleApiKeySection(this.settings.security.api_enabled);
        this.updateShortcutInfo();
    }

    toggleSecretKeyVisibility() {
        const input = document.getElementById('secretKey');
        const icon = document.querySelector('#toggleSecretKey i');

        if (input.type === 'password') {
            input.type = 'text';
            icon.className = 'bi bi-eye-slash';
        } else {
            input.type = 'password';
            icon.className = 'bi bi-eye';
        }
    }

    generateSecretKey() {
        const key = this.generateRandomString(32);
        document.getElementById('secretKey').value = key;
        showNotification('新密钥已生成', 'success');
    }

    async generateApiKey() {
        try {
            const response = await apiRequest('/api/settings/api-key/generate', {
                method: 'POST'
            });

            if (response.ok) {
                const data = await response.json();
                if (data.success) {
                    this.settings.security.api_key = data.api_key;
                    this.settings.security.api_enabled = true;
                    document.getElementById('apiKey').value = data.api_key;
                    document.getElementById('apiEnabled').checked = true;
                    this.toggleApiKeySection(true);
                    this.updateShortcutInfo();
                    showNotification(data.message || '新API密钥已生成', 'success');
                }
            } else {
                const data = await response.json();
                showNotification(data.error || 'API密钥生成失败', 'danger');
            }
        } catch (error) {
            showNotification('网络错误', 'danger');
        }
    }

    generateRandomString(length) {
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
        let result = '';
        for (let i = 0; i < length; i++) {
            result += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        return result;
    }

    toggleCleanupOptions(show) {
        const options = document.getElementById('cleanupOptions');
        options.style.display = show ? 'block' : 'none';
    }

    toggleApiKeySection(show) {
        const section = document.getElementById('apiKeySection');
        section.style.display = show ? 'block' : 'none';
    }

    async saveGeneralSettings() {
        const formData = {
            app_name: document.getElementById('appName').value,
            session_timeout: parseInt(document.getElementById('sessionTimeout').value),
            secret_key: document.getElementById('secretKey').value,
            debug_mode: document.getElementById('debugMode').checked
        };

        try {
            const response = await apiRequest('/api/settings/general', {
                method: 'POST',
                body: JSON.stringify(formData)
            });

            if (response.ok) {
                showNotification('基础设置保存成功', 'success');
                this.settings.general = formData;
            } else {
                showNotification('保存失败', 'danger');
            }
        } catch (error) {
            showNotification('网络错误', 'danger');
        }
    }

    async saveDownloadSettings() {
        const formData = {
            output_dir: document.getElementById('outputDir').value,
            max_concurrent: parseInt(document.getElementById('maxConcurrent').value),
            timeout: parseInt(document.getElementById('downloadTimeout').value),
            default_quality: document.getElementById('defaultQuality').value,
            auto_cleanup: document.getElementById('autoCleanup').checked,
            file_retention_hours: parseInt(document.getElementById('fileRetention').value),
            cleanup_interval: parseInt(document.getElementById('cleanupInterval').value),
            max_storage_mb: parseInt(document.getElementById('maxStorage').value),
            keep_recent_files: parseInt(document.getElementById('keepRecentFiles').value)
        };

        try {
            const response = await apiRequest('/api/settings/download', {
                method: 'POST',
                body: JSON.stringify(formData)
            });

            if (response.ok) {
                showNotification('下载配置保存成功', 'success');
                this.settings.download = formData;
            } else {
                showNotification('保存失败', 'danger');
            }
        } catch (error) {
            showNotification('网络错误', 'danger');
        }
    }

    async changePassword() {
        const current = document.getElementById('currentPassword').value;
        const newPassword = document.getElementById('newPassword').value;
        const confirm = document.getElementById('confirmPassword').value;

        if (newPassword !== confirm) {
            showNotification('新密码和确认密码不匹配', 'danger');
            return;
        }

        try {
            const response = await apiRequest('/api/auth/change-password', {
                method: 'POST',
                body: JSON.stringify({
                    current_password: current,
                    new_password: newPassword
                })
            });

            if (response.ok) {
                showNotification('密码修改成功', 'success');
                document.getElementById('passwordForm').reset();
            } else {
                const data = await response.json();
                showNotification(data.error || '密码修改失败', 'danger');
            }
        } catch (error) {
            showNotification('网络错误', 'danger');
        }
    }

    async saveApiSettings() {
        const formData = {
            api_key: document.getElementById('apiEnabled').checked ? document.getElementById('apiKey').value : ''
        };

        try {
            const response = await apiRequest('/api/settings/api-key', {
                method: 'POST',
                body: JSON.stringify(formData)
            });

            if (response.ok) {
                const data = await response.json();
                showNotification(data.message || 'API设置保存成功', 'success');
                this.settings.security.api_enabled = Boolean(formData.api_key);
                this.settings.security.api_key = formData.api_key;
                this.updateShortcutInfo();
            } else {
                const data = await response.json();
                showNotification(data.error || '保存失败', 'danger');
            }
        } catch (error) {
            showNotification('网络错误', 'danger');
        }
    }

    async checkYtdlpInfo() {
        try {
            const response = await apiRequest('/api/system/ytdlp-info');
            if (response.ok) {
                const data = await response.json();
                document.getElementById('ytdlpVersion').textContent = data.version || '未知版本';
            }
        } catch (error) {
            showNotification('检查yt-dlp信息失败', 'danger');
        }
    }

    async updateYtdlp() {
        if (!confirm('确定要更新yt-dlp吗？这可能需要几分钟时间。')) return;

        try {
            const response = await apiRequest('/api/system/update-ytdlp', {
                method: 'POST'
            });

            if (response.ok) {
                showNotification('yt-dlp更新已开始', 'info');
                setTimeout(() => this.checkYtdlpInfo(), 5000);
            } else {
                showNotification('更新失败', 'danger');
            }
        } catch (error) {
            showNotification('网络错误', 'danger');
        }
    }

    async installYtdlp() {
        if (!confirm('确定要重新安装yt-dlp吗？这将覆盖当前版本。')) return;

        try {
            const response = await apiRequest('/api/system/install-ytdlp', {
                method: 'POST'
            });

            if (response.ok) {
                showNotification('yt-dlp重新安装已开始', 'info');
                setTimeout(() => this.checkYtdlpInfo(), 10000);
            } else {
                showNotification('安装失败', 'danger');
            }
        } catch (error) {
            showNotification('网络错误', 'danger');
        }
    }

    async checkSystemInfo() {
        try {
            const response = await apiRequest('/api/system/info');
            if (response.ok) {
                const data = await response.json();

                document.getElementById('usedSpace').textContent = this.formatSize(data.storage?.used || 0);
                document.getElementById('freeSpace').textContent = this.formatSize(data.storage?.free || 0);
                document.getElementById('uptime').textContent = this.formatUptime(data.uptime || 0);
                document.getElementById('activeDownloads').textContent = data.active_downloads || 0;
            }
        } catch (error) {
            console.error('获取系统信息失败:', error);
        }
    }

    async cleanupFiles() {
        if (!confirm('确定要清理过期文件吗？此操作不可恢复。')) return;

        try {
            const response = await apiRequest('/api/system/cleanup', {
                method: 'POST'
            });

            if (response.ok) {
                showNotification('文件清理完成', 'success');
                this.checkSystemInfo();
            } else {
                showNotification('清理失败', 'danger');
            }
        } catch (error) {
            showNotification('网络错误', 'danger');
        }
    }

    async refreshSystem() {
        try {
            await this.checkSystemInfo();
            await this.checkYtdlpInfo();
            showNotification('系统信息已刷新', 'success');
        } catch (error) {
            showNotification('刷新失败', 'danger');
        }
    }

    async restartService() {
        if (!confirm('确定要重启服务吗？这将中断所有正在进行的下载。')) return;

        try {
            const response = await apiRequest('/api/system/restart', {
                method: 'POST'
            });

            if (response.ok) {
                showNotification('服务重启中...', 'info');
                setTimeout(() => {
                    window.location.reload();
                }, 3000);
            } else {
                showNotification('重启失败', 'danger');
            }
        } catch (error) {
            showNotification('网络错误', 'danger');
        }
    }

    formatSize(bytes) {
        if (!bytes) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    formatUptime(seconds) {
        if (!seconds) return '0秒';
        const days = Math.floor(seconds / 86400);
        const hours = Math.floor((seconds % 86400) / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);

        if (days > 0) return `${days}天 ${hours}小时`;
        if (hours > 0) return `${hours}小时 ${minutes}分钟`;
        return `${minutes}分钟`;
    }

    // iOS快捷指令相关方法
    updateShortcutInfo() {
        const serverUrl = window.location.origin;
        const downloadEndpoint = serverUrl + '/api/shortcuts/download';

        document.getElementById('serverUrl').value = serverUrl;
        document.getElementById('downloadEndpoint').value = downloadEndpoint;

        // 更新API密钥显示
        if (this.settings.security.api_enabled && this.settings.security.api_key) {
            document.getElementById('apiKeyDisplay').value = this.settings.security.api_key;
            document.getElementById('apiKeySection2').style.display = 'block';
            document.getElementById('apiKeyWarning2').style.display = 'none';
        } else {
            document.getElementById('apiKeySection2').style.display = 'none';
            document.getElementById('apiKeyWarning2').style.display = 'block';
        }
    }
}

// 全局函数
async function copyToClipboard(elementId) {
    const element = document.getElementById(elementId);
    const text = element.value;

    try {
        await navigator.clipboard.writeText(text);
        showNotification('已复制到剪贴板', 'success');
    } catch (error) {
        // 降级处理
        element.select();
        document.execCommand('copy');
        showNotification('已复制到剪贴板', 'success');
    }
}

function downloadShortcutTemplate(type) {
    const serverUrl = window.location.origin;
    const apiKey = document.getElementById('apiKey').value;

    if (!apiKey) {
        showNotification('请先生成API密钥', 'danger');
        return;
    }

    let template;

    if (type === 'basic') {
        template = {
            name: "YT-DLP基础下载",
            description: "从剪贴板获取URL并下载视频到文件应用",
            server_url: serverUrl,
            api_key: apiKey,
            endpoints: {
                download: `${serverUrl}/api/shortcuts/download`,
                status: `${serverUrl}/api/shortcuts/status/{download_id}`,
                file: `${serverUrl}/api/shortcuts/file/{filename}`
            },
            instructions: [
                "1. 在iOS快捷指令应用中创建新快捷指令",
                "2. 添加'获取剪贴板'操作",
                "3. 添加'获取URL内容'操作，方法设为POST",
                "4. URL设为: " + serverUrl + "/api/shortcuts/download",
                "5. 请求体设为JSON格式: {\"url\": \"[剪贴板内容]\", \"api_key\": \"" + apiKey + "\"}",
                "6. 添加循环检查下载状态",
                "7. 下载完成后保存文件"
            ]
        };
    } else if (type === 'advanced') {
        template = {
            name: "YT-DLP高级下载",
            description: "支持质量选择和进度显示的高级下载",
            server_url: serverUrl,
            api_key: apiKey,
            endpoints: {
                download: `${serverUrl}/api/shortcuts/download`,
                status: `${serverUrl}/api/shortcuts/status/{download_id}`,
                file: `${serverUrl}/api/shortcuts/file/{filename}`
            },
            features: [
                "质量选择 (最高/中等/低)",
                "音频/视频选择",
                "下载进度显示",
                "错误处理",
                "自动保存到文件应用"
            ],
            instructions: [
                "1. 获取剪贴板内容",
                "2. 显示菜单选择视频质量",
                "3. 询问是否只下载音频",
                "4. 发送下载请求到API",
                "5. 循环检查下载状态并显示进度",
                "6. 下载完成后自动保存文件",
                "7. 显示完成通知"
            ]
        };
    }

    // 创建并下载配置文件
    const blob = new Blob([JSON.stringify(template, null, 2)], {
        type: 'application/json'
    });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `ytdlp-${type}-shortcut-config.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);

    showNotification(`${type === 'basic' ? '基础' : '高级'}快捷指令配置已下载`, 'success');
}

// 初始化应用
document.addEventListener('DOMContentLoaded', function() {
    new SettingsApp();
});
</script>
{% endblock %}
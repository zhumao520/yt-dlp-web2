{% extends "base.html" %}

{% block title %}Êñá‰ª∂ÁÆ°ÁêÜ - YT-DLP Web V2{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-6" x-data="filesApp()">
    
    <!-- È°µÈù¢Ê†áÈ¢ò -->
    <div class="mb-6">
        <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Êñá‰ª∂ÁÆ°ÁêÜ</h1>
        <p class="text-gray-600 dark:text-gray-400 mt-1">ÁÆ°ÁêÜÂ∑≤‰∏ãËΩΩÁöÑÊñá‰ª∂</p>
    </div>
    
    <!-- Á¥ßÂáëÁªüËÆ°‰ø°ÊÅØ -->
    <div class="card p-4 mb-4">
        <div class="flex items-center justify-between text-sm">
            <div class="flex items-center space-x-6">
                <span class="text-gray-600 dark:text-gray-400">
                    ÊÄªËÆ°: <span class="font-semibold text-gray-900 dark:text-white" x-text="stats.total"></span> ‰∏™Êñá‰ª∂
                </span>
                <span class="text-gray-600 dark:text-gray-400">
                    Â§ßÂ∞è: <span class="font-semibold text-gray-900 dark:text-white" x-text="formatSize(stats.totalSize)"></span>
                </span>
                <span class="text-gray-600 dark:text-gray-400">
                    ËßÜÈ¢ë: <span class="font-semibold text-yellow-600 dark:text-yellow-400" x-text="stats.videoCount"></span>
                </span>
                <span class="text-gray-600 dark:text-gray-400">
                    Èü≥È¢ë: <span class="font-semibold text-purple-600 dark:text-purple-400" x-text="stats.audioCount"></span>
                </span>
            </div>
        </div>
    </div>
    
    <!-- Á¥ßÂáëÊìç‰ΩúÊ†è -->
    <div class="card p-3 mb-4">
        <div class="flex flex-wrap items-center gap-3">
            <!-- ÊêúÁ¥¢ -->
            <div class="relative flex-1 min-w-48">
                <input type="text"
                       x-model="searchQuery"
                       @input="filterFiles()"
                       class="input-field pl-8 text-sm"
                       placeholder="ÊêúÁ¥¢Êñá‰ª∂...">
                <div class="absolute inset-y-0 left-0 pl-2 flex items-center pointer-events-none">
                    <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                </div>
            </div>

            <!-- ËøáÊª§ÂíåÊéíÂ∫è -->
            <select x-model="filterType" @change="filterFiles()" class="input-field text-sm">
                <option value="all">ÊâÄÊúâ</option>
                <option value="video">ËßÜÈ¢ë</option>
                <option value="audio">Èü≥È¢ë</option>
            </select>

            <select x-model="sortBy" @change="sortFiles()" class="input-field text-sm">
                <option value="modified">Êó∂Èó¥</option>
                <option value="name">ÂêçÁß∞</option>
                <option value="size">Â§ßÂ∞è</option>
            </select>

            <!-- Êìç‰ΩúÊåâÈíÆ -->
            <button @click="refreshFiles()" class="btn-secondary text-sm">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                </svg>
            </button>

            <button @click="selectAll()" class="btn-secondary text-sm">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
            </button>

            <button @click="deleteSelected()"
                    x-show="selectedFiles.length > 0"
                    class="bg-red-600 hover:bg-red-700 dark:bg-red-700 dark:hover:bg-red-800 text-white text-sm py-2 px-3 rounded">
                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                </svg>
                Âà†Èô§ (<span x-text="selectedFiles.length"></span>)
            </button>
        </div>
    </div>
    
    <!-- Êñá‰ª∂ÂàóË°® -->
    <div class="card">
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                <thead class="bg-gray-100 dark:bg-gray-800">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                            <input type="checkbox" 
                                   @change="toggleSelectAll($event)"
                                   class="rounded border-gray-300">
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                            Êñá‰ª∂Âêç
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                            Â§ßÂ∞è
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                            ‰øÆÊîπÊó∂Èó¥
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                            Êìç‰Ωú
                        </th>
                    </tr>
                </thead>
                <tbody class="bg-white dark:bg-gray-900 divide-y divide-gray-200 dark:divide-gray-700">
                    <template x-for="file in filteredFiles" :key="file.name">
                        <tr class="hover:bg-gray-100 dark:hover:bg-gray-800">
                            <td class="px-6 py-4 whitespace-nowrap">
                                <input type="checkbox" 
                                       :value="file.name"
                                       x-model="selectedFiles"
                                       class="rounded border-gray-300">
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0 h-8 w-8">
                                        <!-- ÂèØÁÇπÂáªÁöÑËßÜÈ¢ëÊñá‰ª∂ÂõæÊ†á -->
                                        <button x-show="isVideoFile(file.name)"
                                                @click="playVideo(file.name)"
                                                class="video-play-icon relative w-8 h-8 text-green-600 dark:text-green-400 hover:text-green-800 dark:hover:text-green-300 hover:bg-green-100 dark:hover:bg-green-900 rounded-lg p-1 transition-all duration-200 group"
                                                title="ÁÇπÂáªÊí≠ÊîæËßÜÈ¢ë">
                                            <!-- ËßÜÈ¢ëÂõæÊ†á -->
                                            <svg class="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                            </svg>
                                            <!-- Êí≠ÊîæÂõæÊ†áË¶ÜÁõñÂ±Ç -->
                                            <div class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity duration-200">
                                                <svg class="w-3 h-3 text-white bg-green-600 dark:bg-green-700 rounded-full p-0.5" fill="currentColor" viewBox="0 0 24 24">
                                                    <path d="M8 5v14l11-7z"/>
                                                </svg>
                                            </div>
                                        </button>
                                        <!-- Èü≥È¢ëÊñá‰ª∂ÂõæÊ†á -->
                                        <svg x-show="isAudioFile(file.name)" class="w-6 h-6 text-purple-600 dark:text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"></path>
                                        </svg>
                                        <!-- ÂÖ∂‰ªñÊñá‰ª∂ÂõæÊ†á -->
                                        <svg x-show="!isVideoFile(file.name) && !isAudioFile(file.name)" class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                        </svg>
                                    </div>
                                    <div class="ml-3">
                                        <div class="text-sm font-medium text-gray-900 dark:text-white" 
                                             x-text="file.name"></div>
                                        <div class="text-sm text-gray-500 dark:text-gray-400" 
                                             x-text="getFileType(file.name)"></div>
                                    </div>
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">
                                <span x-text="formatSize(file.size)"></span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                                <span x-text="formatDate(file.modified)"></span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                <div class="flex items-center space-x-2">
                                    <!-- ‰∏ãËΩΩÊåâÈíÆ -->
                                    <button @click="downloadFile(file.name)"
                                            class="text-blue-600 dark:text-blue-400 hover:text-blue-900 dark:hover:text-blue-300 p-1 rounded hover:bg-blue-100 dark:hover:bg-blue-900 transition-colors duration-200"
                                            title="‰∏ãËΩΩÊñá‰ª∂">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                        </svg>
                                    </button>

                                    <!-- Âà†Èô§ÊåâÈíÆ -->
                                    <button @click="deleteFile(file.name)"
                                            class="text-red-600 dark:text-red-400 hover:text-red-900 dark:hover:text-red-300 p-1 rounded hover:bg-red-100 dark:hover:bg-red-900 transition-colors duration-200"
                                            title="Âà†Èô§Êñá‰ª∂">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                        </svg>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    </template>
                </tbody>
            </table>
            
            <!-- Á©∫Áä∂ÊÄÅ -->
            <div x-show="filteredFiles.length === 0" class="text-center py-12">
                <svg class="w-12 h-12 mx-auto mb-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"></path>
                </svg>
                <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-2">ÊöÇÊó†Êñá‰ª∂</h3>
                <p class="text-gray-500 dark:text-gray-400">
                    <span x-show="searchQuery">Ê≤°ÊúâÊâæÂà∞ÂåπÈÖçÁöÑÊñá‰ª∂</span>
                    <span x-show="!searchQuery">ËøòÊ≤°Êúâ‰∏ãËΩΩ‰ªª‰ΩïÊñá‰ª∂</span>
                </p>
            </div>
        </div>
    </div>

    <!-- ËßÜÈ¢ëÊí≠ÊîæÂô®Ê®°ÊÄÅÊ°Ü -->
    <div x-show="showVideoPlayer"
         x-cloak
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 z-50 overflow-hidden"
         @keydown.escape.window="closeVideoPlayer()">

        <!-- ËÉåÊôØÈÅÆÁΩ© -->
        <div class="fixed inset-0 bg-black bg-opacity-90 transition-opacity"
             @click="closeVideoPlayer()"></div>

        <!-- Êí≠ÊîæÂô®ÂÆπÂô® -->
        <div class="fixed inset-0 flex items-center justify-center p-4">
            <div class="relative w-full max-w-6xl mx-auto"
                 x-transition:enter="transition ease-out duration-300 transform"
                 x-transition:enter-start="opacity-0 scale-95"
                 x-transition:enter-end="opacity-100 scale-100"
                 x-transition:leave="transition ease-in duration-200 transform"
                 x-transition:leave-start="opacity-100 scale-100"
                 x-transition:leave-end="opacity-0 scale-95">

                <!-- ÂÖ≥Èó≠ÊåâÈíÆ -->
                <button @click="closeVideoPlayer()"
                        class="absolute -top-12 right-0 z-10 text-white hover:text-gray-300 transition-colors duration-200">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>

                <!-- ËßÜÈ¢ëÊí≠ÊîæÂô® -->
                <div class="relative bg-black rounded-lg overflow-hidden shadow-2xl">
                    <video x-ref="videoPlayer"
                           class="video-player-fullscreen"
                           controls
                           preload="metadata"
                           playsinline
                           webkit-playsinline>
                        <source :src="currentVideo.url" :type="currentVideo.mimetype || 'video/mp4'">
                        ÊÇ®ÁöÑÊµèËßàÂô®‰∏çÊîØÊåÅËßÜÈ¢ëÊí≠Êîæ„ÄÇ
                    </video>

                    <!-- Âä†ËΩΩÊåáÁ§∫Âô® -->
                    <div x-show="videoLoading"
                         class="absolute inset-0 flex items-center justify-center bg-black bg-opacity-75">
                        <div class="flex flex-col items-center text-white">
                            <svg class="animate-spin h-8 w-8 mb-4" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <div class="text-lg font-medium">Âä†ËΩΩ‰∏≠...</div>
                            <div class="text-sm text-gray-300 mt-1" x-text="currentVideo.name"></div>
                        </div>
                    </div>
                </div>

                <!-- Â∫ïÈÉ®‰ø°ÊÅØÊ†è -->
                <div class="mt-4 bg-gray-900 dark:bg-gray-800 bg-opacity-80 backdrop-blur-sm rounded-lg px-6 py-4">
                    <div class="flex items-center justify-between text-white">
                        <div class="flex-1 min-w-0">
                            <h3 class="text-lg font-medium truncate" x-text="currentVideo.name"></h3>
                            <div class="flex items-center space-x-4 mt-1 text-sm text-gray-300">
                                <span x-text="formatSize(currentVideo.size)"></span>
                                <span x-text="formatDate(currentVideo.modified)"></span>
                            </div>
                        </div>
                        <div class="flex items-center space-x-3 ml-4">
                            <button @click="testVideoUrl()"
                                    class="px-3 py-2 bg-blue-600 hover:bg-blue-700 dark:bg-blue-700 dark:hover:bg-blue-800 text-white text-sm rounded-md transition-colors duration-200 flex items-center">
                                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                ÊµãËØï
                            </button>
                            <button @click="downloadFile(currentVideo.name)"
                                    class="px-3 py-2 bg-green-600 hover:bg-green-700 dark:bg-green-700 dark:hover:bg-green-800 text-white text-sm rounded-md transition-colors duration-200 flex items-center">
                                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                ‰∏ãËΩΩ
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block extra_styles %}
<style>
/* ÈöêËóèÂÖÉÁ¥†ÁöÑÂä®Áîª */
[x-cloak] { display: none !important; }

/* ÂìçÂ∫îÂºèËßÜÈ¢ëÊí≠ÊîæÂô® */
@media (max-width: 768px) {
    .max-w-4xl { max-width: 95vw; }
    .video-player { max-height: 50vh; }
}

/* ÂÖ®Â±èËßÜÈ¢ëÊí≠ÊîæÂô®Ê†∑Âºè */
.video-player-fullscreen {
    width: 100%;
    height: auto;
    max-height: 80vh;
    min-height: 400px;
    background: #000;
    outline: none;
    border-radius: 8px;
}

/* Ëá™ÂÆö‰πâËßÜÈ¢ëÊéß‰ª∂Ê†∑Âºè */
.video-player-fullscreen::-webkit-media-controls-panel {
    background: linear-gradient(180deg, transparent 0%, rgba(0,0,0,0.8) 100%);
    border-radius: 0 0 8px 8px;
}

.video-player-fullscreen::-webkit-media-controls-play-button {
    background-color: rgba(255, 255, 255, 0.9);
    border-radius: 50%;
    width: 48px;
    height: 48px;
}

.video-player-fullscreen::-webkit-media-controls-timeline {
    background-color: rgba(255, 255, 255, 0.3);
    border-radius: 3px;
    height: 6px;
}

.video-player-fullscreen::-webkit-media-controls-timeline::-webkit-slider-thumb {
    background-color: #3b82f6;
    border-radius: 50%;
    width: 16px;
    height: 16px;
}

.video-player-fullscreen::-webkit-media-controls-current-time-display,
.video-player-fullscreen::-webkit-media-controls-time-remaining-display {
    color: white;
    font-size: 14px;
    font-weight: 500;
}

.video-player-fullscreen::-webkit-media-controls-volume-slider {
    background-color: rgba(255, 255, 255, 0.3);
    border-radius: 3px;
}

/* ÂÖ®Â±èÊåâÈíÆÊ†∑Âºè */
.video-player-fullscreen::-webkit-media-controls-fullscreen-button {
    background-color: rgba(255, 255, 255, 0.9);
    border-radius: 4px;
}

/* ÁßªÂä®Á´Ø‰ºòÂåñ */
@media (max-width: 768px) {
    .video-player-fullscreen {
        max-height: 60vh;
        min-height: 300px;
    }

    /* ÁßªÂä®Á´ØÂ∫ïÈÉ®‰ø°ÊÅØÊ†è */
    .mobile-info-bar {
        padding: 1rem;
    }

    .mobile-info-bar h3 {
        font-size: 1rem;
    }

    .mobile-info-bar .button-group {
        flex-direction: column;
        gap: 0.5rem;
    }

    .mobile-info-bar button {
        width: 100%;
        justify-content: center;
    }
}

@media (max-width: 480px) {
    .video-player-fullscreen {
        max-height: 50vh;
        min-height: 250px;
    }
}

/* ËßÜÈ¢ëÂõæÊ†áÁÇπÂáªÊèêÁ§∫ */
.video-play-icon {
    cursor: pointer;
    position: relative;
}

.video-play-icon::after {
    content: '';
    position: absolute;
    top: -2px;
    left: -2px;
    right: -2px;
    bottom: -2px;
    border: 2px solid transparent;
    border-radius: 6px;
    transition: border-color 0.2s ease;
}

.video-play-icon:hover::after {
    border-color: rgba(34, 197, 94, 0.3);
    animation: pulse-border 1.5s infinite;
}

@keyframes pulse-border {
    0%, 100% {
        border-color: rgba(34, 197, 94, 0.3);
    }
    50% {
        border-color: rgba(34, 197, 94, 0.6);
    }
}
</style>
{% endblock %}

{% block extra_scripts %}
<script>
function filesApp() {
    return {
        files: [],
        filteredFiles: [],
        selectedFiles: [],
        searchQuery: '',
        sortBy: 'modified',
        filterType: 'all',
        stats: {
            total: 0,
            totalSize: 0,
            videoCount: 0,
            audioCount: 0
        },
        // ËßÜÈ¢ëÊí≠ÊîæÂô®Áõ∏ÂÖ≥
        showVideoPlayer: false,
        videoLoading: false,
        currentVideo: {
            name: '',
            url: '',
            size: 0,
            modified: 0
        },
        
        async init() {
            await this.loadFiles();
        },
        
        async loadFiles() {
            try {
                const response = await apiRequest('/files/list');
                if (response.ok) {
                    const data = await response.json();
                    this.files = data.files;
                    this.calculateStats();
                    this.filterFiles();
                    // ÂõæÊ†áÂ∑≤Êîπ‰∏∫ÂÜÖËÅîSVGÔºåÊó†ÈúÄÈáçÊñ∞Ê∏≤Êüì
                }
            } catch (error) {
                console.error('Âä†ËΩΩÊñá‰ª∂ÂàóË°®Â§±Ë¥•:', error);
                showNotification('Âä†ËΩΩÊñá‰ª∂ÂàóË°®Â§±Ë¥•', 'error');
            }
        },
        
        calculateStats() {
            this.stats = {
                total: this.files.length,
                totalSize: this.files.reduce((sum, file) => sum + file.size, 0),
                videoCount: this.files.filter(file => this.isVideoFile(file.name)).length,
                audioCount: this.files.filter(file => this.isAudioFile(file.name)).length
            };
        },
        
        filterFiles() {
            let filtered = this.files;
            
            // ÊêúÁ¥¢ËøáÊª§
            if (this.searchQuery) {
                const query = this.searchQuery.toLowerCase();
                filtered = filtered.filter(file => 
                    file.name.toLowerCase().includes(query)
                );
            }
            
            // Á±ªÂûãËøáÊª§
            if (this.filterType !== 'all') {
                filtered = filtered.filter(file => {
                    switch (this.filterType) {
                        case 'video':
                            return this.isVideoFile(file.name);
                        case 'audio':
                            return this.isAudioFile(file.name);
                        case 'other':
                            return !this.isVideoFile(file.name) && !this.isAudioFile(file.name);
                        default:
                            return true;
                    }
                });
            }
            
            this.filteredFiles = filtered;
            this.sortFiles();
        },
        
        sortFiles() {
            this.filteredFiles.sort((a, b) => {
                switch (this.sortBy) {
                    case 'name':
                        return a.name.localeCompare(b.name);
                    case 'size':
                        return b.size - a.size;
                    case 'modified':
                    default:
                        return b.modified - a.modified;
                }
            });
        },
        
        async refreshFiles() {
            await this.loadFiles();
            showNotification('Êñá‰ª∂ÂàóË°®Â∑≤Âà∑Êñ∞', 'success');
        },
        
        selectAll() {
            this.selectedFiles = this.filteredFiles.map(file => file.name);
        },
        
        toggleSelectAll(event) {
            if (event.target.checked) {
                this.selectAll();
            } else {
                this.selectedFiles = [];
            }
        },
        
        downloadFile(filename) {
            window.open(`/files/download/${filename}`, '_blank');
        },

        async playVideo(filename) {
            const file = this.files.find(f => f.name === filename);
            if (!file) {
                showNotification('Êñá‰ª∂‰∏çÂ≠òÂú®', 'error');
                return;
            }

            // Ê†πÊçÆÊñá‰ª∂Êâ©Â±ïÂêçËÆæÁΩÆÊ≠£Á°ÆÁöÑMIMEÁ±ªÂûã
            const ext = filename.split('.').pop().toLowerCase();
            const mimeTypes = {
                'mp4': 'video/mp4',
                'webm': 'video/webm',
                'avi': 'video/x-msvideo',
                'mov': 'video/quicktime',
                'mkv': 'video/x-matroska',
                'flv': 'video/x-flv',
                'wmv': 'video/x-ms-wmv',
                'm4v': 'video/mp4'
            };

            this.currentVideo = {
                name: filename,
                url: `/files/stream/${filename}`,
                size: file.size,
                modified: file.modified,
                mimetype: mimeTypes[ext] || 'video/mp4'
            };

            console.log('ÂáÜÂ§áÊí≠ÊîæËßÜÈ¢ë:', this.currentVideo);
            this.showVideoPlayer = true;
            this.videoLoading = true;

            // Á≠âÂæÖ DOM Êõ¥Êñ∞ÂêéËÆæÁΩÆÂéüÁîüËßÜÈ¢ëÊí≠ÊîæÂô®
            this.$nextTick(() => {
                if (this.$refs.videoPlayer) {
                    const video = this.$refs.videoPlayer;

                    // Ê∏ÖÈô§‰πãÂâçÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®
                    video.removeEventListener('loadstart', this.onLoadStart);
                    video.removeEventListener('canplay', this.onCanPlay);
                    video.removeEventListener('waiting', this.onWaiting);
                    video.removeEventListener('playing', this.onPlaying);
                    video.removeEventListener('error', this.onError);
                    video.removeEventListener('loadedmetadata', this.onLoadedMetadata);

                    // Ê∑ªÂä†‰∫ã‰ª∂ÁõëÂê¨Âô®
                    this.onLoadStart = () => {
                        console.log('üé¨ ÂºÄÂßãÂä†ËΩΩËßÜÈ¢ë:', this.currentVideo.url);
                        this.videoLoading = true;
                    };

                    this.onLoadedMetadata = () => {
                        console.log('üìä ËßÜÈ¢ëÂÖÉÊï∞ÊçÆÂä†ËΩΩÂÆåÊàê');
                        console.log('ËßÜÈ¢ëÂ∞∫ÂØ∏:', video.videoWidth, 'x', video.videoHeight);
                        console.log('ËßÜÈ¢ëÊó∂Èïø:', video.duration, 'Áßí');
                    };

                    this.onCanPlay = () => {
                        console.log('‚úÖ ËßÜÈ¢ëÂèØ‰ª•Êí≠Êîæ');
                        this.videoLoading = false;
                    };

                    this.onWaiting = () => {
                        console.log('‚è≥ ËßÜÈ¢ëÁºìÂÜ≤‰∏≠');
                        this.videoLoading = true;
                    };

                    this.onPlaying = () => {
                        console.log('‚ñ∂Ô∏è ËßÜÈ¢ëÂºÄÂßãÊí≠Êîæ');
                        this.videoLoading = false;
                    };

                    this.onError = (event) => {
                        console.error('‚ùå ËßÜÈ¢ëÊí≠ÊîæÈîôËØØ:', event);
                        console.error('ÈîôËØØËØ¶ÊÉÖ:', video.error);
                        this.videoLoading = false;

                        let errorMessage = 'ËßÜÈ¢ëÊí≠ÊîæÂ§±Ë¥•';
                        if (video.error) {
                            switch (video.error.code) {
                                case 1:
                                    errorMessage = 'ËßÜÈ¢ëÂä†ËΩΩË¢´‰∏≠Ê≠¢';
                                    break;
                                case 2:
                                    errorMessage = 'ÁΩëÁªúÈîôËØØ';
                                    break;
                                case 3:
                                    errorMessage = 'ËßÜÈ¢ëËß£Á†ÅÈîôËØØ';
                                    break;
                                case 4:
                                    errorMessage = 'ËßÜÈ¢ëÊ†ºÂºè‰∏çÊîØÊåÅ';
                                    break;
                            }
                        }
                        showNotification(errorMessage + 'ÔºåÂª∫ËÆÆ‰∏ãËΩΩÂêéËßÇÁúã', 'error');
                    };

                    // ÁªëÂÆö‰∫ã‰ª∂
                    video.addEventListener('loadstart', this.onLoadStart);
                    video.addEventListener('loadedmetadata', this.onLoadedMetadata);
                    video.addEventListener('canplay', this.onCanPlay);
                    video.addEventListener('waiting', this.onWaiting);
                    video.addEventListener('playing', this.onPlaying);
                    video.addEventListener('error', this.onError);

                    // Âº∫Âà∂ÈáçÊñ∞Âä†ËΩΩËßÜÈ¢ë
                    video.load();
                    console.log('üîÑ Âº∫Âà∂ÈáçÊñ∞Âä†ËΩΩËßÜÈ¢ë');
                }
            });
        },

        async testVideoUrl() {
            try {
                console.log('üß™ ÊµãËØïËßÜÈ¢ëURL:', this.currentVideo.url);
                const response = await fetch(this.currentVideo.url, {
                    method: 'HEAD',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('auth_token')}`
                    }
                });

                console.log('üìä ÂìçÂ∫îÁä∂ÊÄÅ:', response.status);
                console.log('üìä ÂìçÂ∫îÂ§¥:', Object.fromEntries(response.headers.entries()));

                if (response.ok) {
                    showNotification('ËßÜÈ¢ëURLÊµãËØïÊàêÂäü', 'success');
                } else {
                    showNotification(`ËßÜÈ¢ëURLÊµãËØïÂ§±Ë¥•: ${response.status}`, 'error');
                }
            } catch (error) {
                console.error('‚ùå ÊµãËØïÂ§±Ë¥•:', error);
                showNotification('ÁΩëÁªúÈîôËØØ', 'error');
            }
        },

        closeVideoPlayer() {
            // ÂÅúÊ≠¢ËßÜÈ¢ëÊí≠ÊîæÂπ∂Ê∏ÖÁêÜ
            if (this.$refs.videoPlayer) {
                const video = this.$refs.videoPlayer;
                video.pause();
                video.currentTime = 0;

                // ÁßªÈô§‰∫ã‰ª∂ÁõëÂê¨Âô®
                video.removeEventListener('loadstart', this.onLoadStart);
                video.removeEventListener('loadedmetadata', this.onLoadedMetadata);
                video.removeEventListener('canplay', this.onCanPlay);
                video.removeEventListener('waiting', this.onWaiting);
                video.removeEventListener('playing', this.onPlaying);
                video.removeEventListener('error', this.onError);

                console.log('üîö ËßÜÈ¢ëÊí≠ÊîæÂô®Â∑≤ÂÖ≥Èó≠');
            }

            this.showVideoPlayer = false;
            this.videoLoading = false;
        },


        
        async deleteFile(filename) {
            if (!confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§Êñá‰ª∂ "${filename}" ÂêóÔºü`)) return;
            
            try {
                const response = await apiRequest(`/files/delete/${filename}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    showNotification('Êñá‰ª∂Âà†Èô§ÊàêÂäü', 'success');
                    await this.loadFiles();
                } else {
                    showNotification('Êñá‰ª∂Âà†Èô§Â§±Ë¥•', 'error');
                }
            } catch (error) {
                showNotification('ÁΩëÁªúÈîôËØØ', 'error');
            }
        },
        
        async deleteSelected() {
            if (this.selectedFiles.length === 0) return;
            
            if (!confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§ÈÄâ‰∏≠ÁöÑ ${this.selectedFiles.length} ‰∏™Êñá‰ª∂ÂêóÔºü`)) return;
            
            try {
                const promises = this.selectedFiles.map(filename =>
                    apiRequest(`/files/delete/${filename}`, { method: 'DELETE' })
                );
                
                await Promise.all(promises);
                showNotification(`ÊàêÂäüÂà†Èô§ ${this.selectedFiles.length} ‰∏™Êñá‰ª∂`, 'success');
                this.selectedFiles = [];
                await this.loadFiles();
            } catch (error) {
                showNotification('ÊâπÈáèÂà†Èô§Â§±Ë¥•', 'error');
            }
        },

        getFileIcon(filename) {
            if (this.isVideoFile(filename)) return 'video';
            if (this.isAudioFile(filename)) return 'music';
            return 'file';
        },

        formatDate(timestamp) {
            if (!timestamp) return '';
            const date = new Date(timestamp * 1000);
            return date.toLocaleDateString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        },
        
        getFileType(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            if (this.isVideoFile(filename)) return 'ËßÜÈ¢ëÊñá‰ª∂';
            if (this.isAudioFile(filename)) return 'Èü≥È¢ëÊñá‰ª∂';
            return ext.toUpperCase() + ' Êñá‰ª∂';
        },
        
        isVideoFile(filename) {
            const videoExts = ['mp4', 'avi', 'mkv', 'mov', 'wmv', 'flv', 'webm', 'm4v'];
            const ext = filename.split('.').pop().toLowerCase();
            return videoExts.includes(ext);
        },
        
        isAudioFile(filename) {
            const audioExts = ['mp3', 'wav', 'flac', 'aac', 'm4a', 'ogg', 'wma'];
            const ext = filename.split('.').pop().toLowerCase();
            return audioExts.includes(ext);
        },
        
        formatSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        },
        
        formatDate(timestamp) {
            return new Date(timestamp * 1000).toLocaleString('zh-CN');
        }
    }
}
</script>
{% endblock %}
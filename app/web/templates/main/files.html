{% extends "base.html" %}

{% block title %}文件管理 - YT-DLP Web V2{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-6" x-data="filesApp()">
    
    <!-- 页面标题 -->
    <div class="mb-6">
        <h1 class="text-2xl font-bold text-gray-900 dark:text-white">文件管理</h1>
        <p class="text-gray-600 dark:text-gray-400 mt-1">管理已下载的文件</p>
    </div>
    
    <!-- 统计信息 -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <div class="card p-4">
            <div class="flex items-center">
                <div class="p-2 bg-blue-100 dark:bg-blue-900 rounded-lg">
                    <i data-feather="file" class="w-6 h-6 text-blue-600 dark:text-blue-400"></i>
                </div>
                <div class="ml-3">
                    <p class="text-sm font-medium text-gray-600 dark:text-gray-400">总文件数</p>
                    <p class="text-lg font-semibold text-gray-900 dark:text-white" x-text="stats.total"></p>
                </div>
            </div>
        </div>
        
        <div class="card p-4">
            <div class="flex items-center">
                <div class="p-2 bg-green-100 dark:bg-green-900 rounded-lg">
                    <i data-feather="hard-drive" class="w-6 h-6 text-green-600 dark:text-green-400"></i>
                </div>
                <div class="ml-3">
                    <p class="text-sm font-medium text-gray-600 dark:text-gray-400">总大小</p>
                    <p class="text-lg font-semibold text-gray-900 dark:text-white" x-text="formatSize(stats.totalSize)"></p>
                </div>
            </div>
        </div>
        
        <div class="card p-4">
            <div class="flex items-center">
                <div class="p-2 bg-yellow-100 dark:bg-yellow-900 rounded-lg">
                    <i data-feather="video" class="w-6 h-6 text-yellow-600 dark:text-yellow-400"></i>
                </div>
                <div class="ml-3">
                    <p class="text-sm font-medium text-gray-600 dark:text-gray-400">视频文件</p>
                    <p class="text-lg font-semibold text-gray-900 dark:text-white" x-text="stats.videoCount"></p>
                </div>
            </div>
        </div>
        
        <div class="card p-4">
            <div class="flex items-center">
                <div class="p-2 bg-purple-100 dark:bg-purple-900 rounded-lg">
                    <i data-feather="music" class="w-6 h-6 text-purple-600 dark:text-purple-400"></i>
                </div>
                <div class="ml-3">
                    <p class="text-sm font-medium text-gray-600 dark:text-gray-400">音频文件</p>
                    <p class="text-lg font-semibold text-gray-900 dark:text-white" x-text="stats.audioCount"></p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 操作栏 -->
    <div class="card p-4 mb-6">
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-4">
                <!-- 搜索 -->
                <div class="relative">
                    <input type="text" 
                           x-model="searchQuery" 
                           @input="filterFiles()"
                           class="input-field pl-10 w-64" 
                           placeholder="搜索文件...">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i data-feather="search" class="w-5 h-5 text-gray-400"></i>
                    </div>
                </div>
                
                <!-- 排序 -->
                <select x-model="sortBy" @change="sortFiles()" class="input-field">
                    <option value="modified">按修改时间</option>
                    <option value="name">按文件名</option>
                    <option value="size">按文件大小</option>
                </select>
                
                <!-- 文件类型过滤 -->
                <select x-model="filterType" @change="filterFiles()" class="input-field">
                    <option value="all">所有文件</option>
                    <option value="video">视频文件</option>
                    <option value="audio">音频文件</option>
                    <option value="other">其他文件</option>
                </select>
            </div>
            
            <div class="flex items-center space-x-2">
                <button @click="refreshFiles()" class="btn-secondary">
                    <i data-feather="refresh-cw" class="w-4 h-4 mr-2"></i>
                    刷新
                </button>
                
                <button @click="selectAll()" class="btn-secondary">
                    <i data-feather="check-square" class="w-4 h-4 mr-2"></i>
                    全选
                </button>
                
                <button @click="deleteSelected()" 
                        x-show="selectedFiles.length > 0"
                        class="bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-4 rounded-lg">
                    <i data-feather="trash-2" class="w-4 h-4 mr-2"></i>
                    删除选中 (<span x-text="selectedFiles.length"></span>)
                </button>
            </div>
        </div>
    </div>
    
    <!-- 文件列表 -->
    <div class="card">
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                <thead class="bg-gray-50 dark:bg-gray-800">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                            <input type="checkbox" 
                                   @change="toggleSelectAll($event)"
                                   class="rounded border-gray-300">
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                            文件名
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                            大小
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                            修改时间
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                            操作
                        </th>
                    </tr>
                </thead>
                <tbody class="bg-white dark:bg-gray-900 divide-y divide-gray-200 dark:divide-gray-700">
                    <template x-for="file in filteredFiles" :key="file.name">
                        <tr class="hover:bg-gray-50 dark:hover:bg-gray-800">
                            <td class="px-6 py-4 whitespace-nowrap">
                                <input type="checkbox" 
                                       :value="file.name"
                                       x-model="selectedFiles"
                                       class="rounded border-gray-300">
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0 h-8 w-8">
                                        <i :data-feather="getFileIcon(file.name)" 
                                           class="w-6 h-6 text-gray-400"></i>
                                    </div>
                                    <div class="ml-3">
                                        <div class="text-sm font-medium text-gray-900 dark:text-white" 
                                             x-text="file.name"></div>
                                        <div class="text-sm text-gray-500 dark:text-gray-400" 
                                             x-text="getFileType(file.name)"></div>
                                    </div>
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">
                                <span x-text="formatSize(file.size)"></span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                                <span x-text="formatDate(file.modified)"></span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                <div class="flex items-center space-x-2">
                                    <!-- 在线播放按钮 -->
                                    <button x-show="isVideoFile(file.name)"
                                            @click="playVideo(file.name)"
                                            class="text-green-600 dark:text-green-400 hover:text-green-900 dark:hover:text-green-300"
                                            title="在线播放">
                                        <i data-feather="play" class="w-4 h-4"></i>
                                    </button>

                                    <!-- 下载按钮 -->
                                    <button @click="downloadFile(file.name)"
                                            class="text-blue-600 dark:text-blue-400 hover:text-blue-900 dark:hover:text-blue-300"
                                            title="下载文件">
                                        <i data-feather="download" class="w-4 h-4"></i>
                                    </button>

                                    <!-- 删除按钮 -->
                                    <button @click="deleteFile(file.name)"
                                            class="text-red-600 dark:text-red-400 hover:text-red-900 dark:hover:text-red-300"
                                            title="删除文件">
                                        <i data-feather="trash-2" class="w-4 h-4"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    </template>
                </tbody>
            </table>
            
            <!-- 空状态 -->
            <div x-show="filteredFiles.length === 0" class="text-center py-12">
                <i data-feather="folder" class="w-12 h-12 mx-auto mb-4 text-gray-400"></i>
                <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-2">暂无文件</h3>
                <p class="text-gray-500 dark:text-gray-400">
                    <span x-show="searchQuery">没有找到匹配的文件</span>
                    <span x-show="!searchQuery">还没有下载任何文件</span>
                </p>
            </div>
        </div>
    </div>

    <!-- 视频播放器模态框 -->
    <div x-show="showVideoPlayer"
         x-cloak
         class="fixed inset-0 z-50 overflow-y-auto"
         @keydown.escape.window="closeVideoPlayer()">
        <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <!-- 背景遮罩 -->
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"
                 @click="closeVideoPlayer()"></div>

            <!-- 模态框内容 -->
            <div class="inline-block align-bottom bg-white dark:bg-gray-800 rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-4xl sm:w-full">
                <!-- 头部 -->
                <div class="bg-white dark:bg-gray-800 px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-medium text-gray-900 dark:text-white"
                            x-text="currentVideo.name">
                            视频播放
                        </h3>
                        <button @click="closeVideoPlayer()"
                                class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                            <i data-feather="x" class="w-6 h-6"></i>
                        </button>
                    </div>

                    <!-- 视频播放器 -->
                    <div class="relative bg-black rounded-lg overflow-hidden">
                        <video x-ref="videoPlayer"
                               class="w-full h-auto max-h-96"
                               controls
                               preload="metadata"
                               @loadedmetadata="onVideoLoaded()"
                               @error="onVideoError()">
                            <source :src="currentVideo.url" type="video/mp4">
                            <source :src="currentVideo.url" type="video/webm">
                            <source :src="currentVideo.url" type="video/ogg">
                            您的浏览器不支持视频播放。
                        </video>

                        <!-- 加载指示器 -->
                        <div x-show="videoLoading"
                             class="absolute inset-0 flex items-center justify-center bg-black bg-opacity-50">
                            <div class="flex items-center text-white">
                                <svg class="animate-spin h-6 w-6 mr-3" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                加载中...
                            </div>
                        </div>
                    </div>

                    <!-- 视频信息 -->
                    <div class="mt-4 text-sm text-gray-600 dark:text-gray-400">
                        <div class="flex items-center justify-between">
                            <span>文件大小: <span x-text="formatSize(currentVideo.size)"></span></span>
                            <span>修改时间: <span x-text="formatDate(currentVideo.modified)"></span></span>
                        </div>
                    </div>
                </div>

                <!-- 底部操作 -->
                <div class="bg-gray-50 dark:bg-gray-700 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button @click="downloadFile(currentVideo.name)"
                            class="btn-primary sm:ml-3">
                        <i data-feather="download" class="w-4 h-4 mr-2"></i>
                        下载文件
                    </button>
                    <button @click="closeVideoPlayer()"
                            class="btn-secondary mt-3 sm:mt-0">
                        关闭
                    </button>
                </div>
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block extra_styles %}
<style>
/* 视频播放器样式 */
.video-player-modal {
    backdrop-filter: blur(4px);
}

.video-player-container {
    position: relative;
    background: #000;
    border-radius: 8px;
    overflow: hidden;
}

.video-player-container video {
    width: 100%;
    height: auto;
    max-height: 70vh;
    display: block;
}

/* 自定义视频控件样式 */
video::-webkit-media-controls-panel {
    background-color: rgba(0, 0, 0, 0.8);
}

video::-webkit-media-controls-play-button,
video::-webkit-media-controls-volume-slider,
video::-webkit-media-controls-timeline {
    filter: invert(1);
}

/* 加载动画 */
.loading-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 16px;
}

/* 响应式设计 */
@media (max-width: 768px) {
    .video-player-container video {
        max-height: 50vh;
    }
}

/* 隐藏元素的动画 */
[x-cloak] {
    display: none !important;
}
</style>
{% endblock %}

{% block extra_scripts %}
<script>
function filesApp() {
    return {
        files: [],
        filteredFiles: [],
        selectedFiles: [],
        searchQuery: '',
        sortBy: 'modified',
        filterType: 'all',
        stats: {
            total: 0,
            totalSize: 0,
            videoCount: 0,
            audioCount: 0
        },
        // 视频播放器相关
        showVideoPlayer: false,
        videoLoading: false,
        currentVideo: {
            name: '',
            url: '',
            size: 0,
            modified: 0
        },
        
        async init() {
            await this.loadFiles();
        },
        
        async loadFiles() {
            try {
                const response = await apiRequest('/files/list');
                if (response.ok) {
                    const data = await response.json();
                    this.files = data.files;
                    this.calculateStats();
                    this.filterFiles();
                    this.$nextTick(() => feather.replace());
                }
            } catch (error) {
                console.error('加载文件列表失败:', error);
                showNotification('加载文件列表失败', 'error');
            }
        },
        
        calculateStats() {
            this.stats = {
                total: this.files.length,
                totalSize: this.files.reduce((sum, file) => sum + file.size, 0),
                videoCount: this.files.filter(file => this.isVideoFile(file.name)).length,
                audioCount: this.files.filter(file => this.isAudioFile(file.name)).length
            };
        },
        
        filterFiles() {
            let filtered = this.files;
            
            // 搜索过滤
            if (this.searchQuery) {
                const query = this.searchQuery.toLowerCase();
                filtered = filtered.filter(file => 
                    file.name.toLowerCase().includes(query)
                );
            }
            
            // 类型过滤
            if (this.filterType !== 'all') {
                filtered = filtered.filter(file => {
                    switch (this.filterType) {
                        case 'video':
                            return this.isVideoFile(file.name);
                        case 'audio':
                            return this.isAudioFile(file.name);
                        case 'other':
                            return !this.isVideoFile(file.name) && !this.isAudioFile(file.name);
                        default:
                            return true;
                    }
                });
            }
            
            this.filteredFiles = filtered;
            this.sortFiles();
        },
        
        sortFiles() {
            this.filteredFiles.sort((a, b) => {
                switch (this.sortBy) {
                    case 'name':
                        return a.name.localeCompare(b.name);
                    case 'size':
                        return b.size - a.size;
                    case 'modified':
                    default:
                        return b.modified - a.modified;
                }
            });
        },
        
        async refreshFiles() {
            await this.loadFiles();
            showNotification('文件列表已刷新', 'success');
        },
        
        selectAll() {
            this.selectedFiles = this.filteredFiles.map(file => file.name);
        },
        
        toggleSelectAll(event) {
            if (event.target.checked) {
                this.selectAll();
            } else {
                this.selectedFiles = [];
            }
        },
        
        downloadFile(filename) {
            window.open(`/files/download/${filename}`, '_blank');
        },

        playVideo(filename) {
            const file = this.files.find(f => f.name === filename);
            if (!file) return;

            this.currentVideo = {
                name: filename,
                url: `/files/stream/${filename}`,
                size: file.size,
                modified: file.modified
            };

            this.showVideoPlayer = true;
            this.videoLoading = true;

            // 确保图标重新渲染
            this.$nextTick(() => {
                feather.replace();
            });
        },

        closeVideoPlayer() {
            this.showVideoPlayer = false;
            this.videoLoading = false;

            // 停止视频播放
            if (this.$refs.videoPlayer) {
                this.$refs.videoPlayer.pause();
                this.$refs.videoPlayer.currentTime = 0;
            }
        },

        onVideoLoaded() {
            this.videoLoading = false;
        },

        onVideoError() {
            this.videoLoading = false;
            showNotification('视频加载失败，可能是格式不支持', 'error');
        },
        
        async deleteFile(filename) {
            if (!confirm(`确定要删除文件 "${filename}" 吗？`)) return;
            
            try {
                const response = await apiRequest(`/files/delete/${filename}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    showNotification('文件删除成功', 'success');
                    await this.loadFiles();
                } else {
                    showNotification('文件删除失败', 'error');
                }
            } catch (error) {
                showNotification('网络错误', 'error');
            }
        },
        
        async deleteSelected() {
            if (this.selectedFiles.length === 0) return;
            
            if (!confirm(`确定要删除选中的 ${this.selectedFiles.length} 个文件吗？`)) return;
            
            try {
                const promises = this.selectedFiles.map(filename =>
                    apiRequest(`/files/delete/${filename}`, { method: 'DELETE' })
                );
                
                await Promise.all(promises);
                showNotification(`成功删除 ${this.selectedFiles.length} 个文件`, 'success');
                this.selectedFiles = [];
                await this.loadFiles();
            } catch (error) {
                showNotification('批量删除失败', 'error');
            }
        },
        
        getFileIcon(filename) {
            if (this.isVideoFile(filename)) return 'video';
            if (this.isAudioFile(filename)) return 'music';
            return 'file';
        },
        
        getFileType(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            if (this.isVideoFile(filename)) return '视频文件';
            if (this.isAudioFile(filename)) return '音频文件';
            return ext.toUpperCase() + ' 文件';
        },
        
        isVideoFile(filename) {
            const videoExts = ['mp4', 'avi', 'mkv', 'mov', 'wmv', 'flv', 'webm', 'm4v'];
            const ext = filename.split('.').pop().toLowerCase();
            return videoExts.includes(ext);
        },
        
        isAudioFile(filename) {
            const audioExts = ['mp3', 'wav', 'flac', 'aac', 'm4a', 'ogg', 'wma'];
            const ext = filename.split('.').pop().toLowerCase();
            return audioExts.includes(ext);
        },
        
        formatSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        },
        
        formatDate(timestamp) {
            return new Date(timestamp * 1000).toLocaleString('zh-CN');
        }
    }
}
</script>
{% endblock %}

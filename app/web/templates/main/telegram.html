{% extends "base.html" %}

{% block title %}Telegramé…ç½® - YT-DLP Web V2{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-6" x-data="telegramApp()">
    
    <!-- é¡µé¢æ ‡é¢˜ -->
    <div class="mb-6">
        <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Telegramé…ç½®</h1>
        <p class="text-gray-600 dark:text-gray-400 mt-1">é…ç½®Telegramæœºå™¨äººæ¨é€å’Œè‡ªåŠ¨ä¸‹è½½åŠŸèƒ½</p>
    </div>
    
    <!-- é…ç½®çŠ¶æ€å¡ç‰‡ -->
    <div class="card p-6 mb-6">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-semibold flex items-center">
                <i data-feather="activity" class="w-5 h-5 mr-2"></i>
                è¿æ¥çŠ¶æ€
            </h2>
            <button @click="testConnection()" 
                    :disabled="testing"
                    class="btn-secondary">
                <template x-if="testing">
                    <div class="flex items-center">
                        <svg class="animate-spin h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        æµ‹è¯•ä¸­...
                    </div>
                </template>
                <template x-if="!testing">
                    <div class="flex items-center">
                        <i data-feather="wifi" class="w-4 h-4 mr-2"></i>
                        æµ‹è¯•è¿æ¥
                    </div>
                </template>
            </button>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="flex items-center p-3 rounded-lg bg-gray-50 dark:bg-gray-700">
                <div class="flex items-center">
                    <i data-feather="message-circle" class="w-5 h-5 mr-3"></i>
                    <span>Bot API</span>
                </div>
                <div class="ml-auto flex items-center">
                    <i :data-feather="connectionStatus.bot_api ? 'check' : 'x'" 
                       :class="connectionStatus.bot_api ? 'text-green-500' : 'text-red-500'" 
                       class="w-5 h-5"></i>
                    <span class="ml-2 text-sm" 
                          :class="connectionStatus.bot_api ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'">
                        <span x-text="connectionStatus.bot_api ? 'æ­£å¸¸' : 'å¼‚å¸¸'"></span>
                    </span>
                </div>
            </div>
            
            <div class="flex items-center p-3 rounded-lg bg-gray-50 dark:bg-gray-700">
                <div class="flex items-center">
                    <i data-feather="upload" class="w-5 h-5 mr-3"></i>
                    <span>Pyrogram</span>
                </div>
                <div class="ml-auto flex items-center">
                    <i :data-feather="connectionStatus.pyrogram ? 'check' : 'x'" 
                       :class="connectionStatus.pyrogram ? 'text-green-500' : 'text-red-500'" 
                       class="w-5 h-5"></i>
                    <span class="ml-2 text-sm" 
                          :class="connectionStatus.pyrogram ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'">
                        <span x-text="connectionStatus.pyrogram ? 'æ­£å¸¸' : 'å¼‚å¸¸'"></span>
                    </span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- åŸºç¡€é…ç½® -->
    <div class="card p-6 mb-6">
        <h2 class="text-lg font-semibold mb-4 flex items-center">
            <i data-feather="settings" class="w-5 h-5 mr-2"></i>
            åŸºç¡€é…ç½®
        </h2>
        
        <form @submit.prevent="saveConfig()" class="space-y-4">
            <!-- å¯ç”¨å¼€å…³ -->
            <div class="flex items-center justify-between p-4 border border-gray-200 dark:border-gray-600 rounded-lg">
                <div>
                    <h3 class="font-medium">å¯ç”¨TelegramåŠŸèƒ½</h3>
                    <p class="text-sm text-gray-600 dark:text-gray-400">å¼€å¯åå¯ä»¥æ¥æ”¶æ¨é€é€šçŸ¥å’Œä½¿ç”¨æœºå™¨äººä¸‹è½½</p>
                </div>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" x-model="config.enabled" class="sr-only peer">
                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600"></div>
                </label>
            </div>
            
            <!-- Boté…ç½® -->
            <div x-show="config.enabled" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2">Bot Token</label>
                    <input type="text" x-model="config.bot_token" class="input-field" 
                           placeholder="123456789:ABCdefGHIjklMNOpqrsTUVwxyz">
                    <p class="text-xs text-gray-500 mt-1">ä» @BotFather è·å–çš„æœºå™¨äººä»¤ç‰Œ</p>
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-2">Chat ID</label>
                    <input type="text" x-model="config.chat_id" class="input-field" 
                           placeholder="-1001234567890">
                    <p class="text-xs text-gray-500 mt-1">æ¥æ”¶æ¶ˆæ¯çš„èŠå¤©IDï¼Œå¯ä»¥æ˜¯ä¸ªäººæˆ–ç¾¤ç»„</p>
                </div>
                
                <!-- Pyrogramé…ç½® -->
                <div class="border-t border-gray-200 dark:border-gray-700 pt-4">
                    <h3 class="font-medium mb-3 flex items-center">
                        <i data-feather="upload" class="w-4 h-4 mr-2"></i>
                        Pyrogramé…ç½® (å¤§æ–‡ä»¶æ”¯æŒ)
                    </h3>

                    <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-3 mb-4">
                        <div class="flex items-start">
                            <i data-feather="info" class="w-4 h-4 mr-2 mt-0.5 text-blue-600 dark:text-blue-400"></i>
                            <div class="text-sm text-blue-800 dark:text-blue-400">
                                <p class="font-medium mb-1">é…ç½®Pyrogramä»¥å‘é€50MBä»¥ä¸Šçš„å¤§æ–‡ä»¶</p>
                                <p>éœ€è¦ä» <a href="https://my.telegram.org" target="_blank" class="underline hover:no-underline">my.telegram.org</a> è·å–APIå‡­æ®</p>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">API ID</label>
                            <input type="number" x-model="config.api_id" class="input-field"
                                   placeholder="12345678">
                            <p class="text-xs text-gray-500 mt-1">çº¯æ•°å­—ï¼Œä¾‹å¦‚ï¼š12345678</p>
                        </div>

                        <div>
                            <label class="block text-sm font-medium mb-2">API Hash</label>
                            <input type="text" x-model="config.api_hash" class="input-field"
                                   placeholder="abcdef1234567890abcdef1234567890">
                            <p class="text-xs text-gray-500 mt-1">32ä½å­—ç¬¦ä¸²</p>
                        </div>
                    </div>

                    <div class="mt-3 p-3 bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg">
                        <div class="flex items-start">
                            <i data-feather="help-circle" class="w-4 h-4 mr-2 mt-0.5 text-yellow-600 dark:text-yellow-400"></i>
                            <div class="text-sm text-yellow-800 dark:text-yellow-400">
                                <p class="font-medium mb-1">å¦‚ä½•è·å–APIå‡­æ®ï¼Ÿ</p>
                                <ol class="list-decimal list-inside space-y-1 text-xs">
                                    <li>è®¿é—® <a href="https://my.telegram.org" target="_blank" class="underline">my.telegram.org</a></li>
                                    <li>ç”¨æ‰‹æœºå·ç™»å½•ï¼ˆä¸Telegramè´¦å·ç›¸åŒï¼‰</li>
                                    <li>ç‚¹å‡» "API development tools"</li>
                                    <li>åˆ›å»ºåº”ç”¨ï¼Œè·å–API IDå’ŒAPI Hash</li>
                                </ol>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- æ¨é€æ¨¡å¼ -->
                <div>
                    <label class="block text-sm font-medium mb-2">æ¨é€æ¨¡å¼</label>
                    <select x-model="config.push_mode" class="input-field">
                        <option value="notification">ä»…é€šçŸ¥æ¶ˆæ¯</option>
                        <option value="file">æ™ºèƒ½æ¨é€ (æ¨è)</option>
                        <option value="both">é€šçŸ¥+æ–‡ä»¶</option>
                    </select>
                    <p class="text-xs text-gray-500 mt-1">
                        æ™ºèƒ½æ¨é€ï¼šå°æ–‡ä»¶(&lt;50MB)ç›´æ¥å‘é€ï¼Œå¤§æ–‡ä»¶å‘é€é€šçŸ¥
                    </p>
                </div>
                
                <!-- è‡ªåŠ¨ä¸‹è½½ -->
                <div class="flex items-center">
                    <input type="checkbox" x-model="config.auto_download" 
                           class="mr-2" id="auto_download">
                    <label for="auto_download" class="text-sm">
                        å¯ç”¨æœºå™¨äººè‡ªåŠ¨ä¸‹è½½ (å‘é€é“¾æ¥ç»™æœºå™¨äººè‡ªåŠ¨ä¸‹è½½)
                    </label>
                </div>
                
                <!-- æ–‡ä»¶å¤§å°é™åˆ¶ -->
                <div>
                    <label class="block text-sm font-medium mb-2">æ–‡ä»¶å¤§å°é™åˆ¶ (MB)</label>
                    <input type="number" x-model="config.file_size_limit" class="input-field" 
                           min="1" max="2000" placeholder="50">
                    <p class="text-xs text-gray-500 mt-1">è¶…è¿‡æ­¤å¤§å°çš„æ–‡ä»¶éœ€è¦Pyrogramæ”¯æŒ</p>
                </div>
            </div>
            
            <button type="submit" class="btn-primary">
                <i data-feather="save" class="w-4 h-4 mr-2"></i>
                ä¿å­˜é…ç½®
            </button>
        </form>
    </div>
    
    <!-- æœºå™¨äººä½¿ç”¨è¯´æ˜ -->
    <div x-show="config.enabled && config.auto_download" class="card p-6">
        <h2 class="text-lg font-semibold mb-4 flex items-center">
            <i data-feather="help-circle" class="w-5 h-5 mr-2"></i>
            ä½¿ç”¨è¯´æ˜
        </h2>
        
        <div class="space-y-4">
            <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4">
                <h3 class="font-medium text-blue-900 dark:text-blue-300 mb-2">å¦‚ä½•ä½¿ç”¨æœºå™¨äººä¸‹è½½</h3>
                <ol class="text-sm text-blue-800 dark:text-blue-400 space-y-1 list-decimal list-inside">
                    <li>å°†æœºå™¨äººæ·»åŠ åˆ°æ‚¨çš„èŠå¤©ä¸­</li>
                    <li>ç›´æ¥å‘é€è§†é¢‘é“¾æ¥ç»™æœºå™¨äºº</li>
                    <li>æœºå™¨äººä¼šè‡ªåŠ¨å¼€å§‹ä¸‹è½½</li>
                    <li>ä¸‹è½½å®Œæˆåè‡ªåŠ¨å‘é€æ–‡ä»¶</li>
                </ol>
            </div>
            
            <div class="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg p-4">
                <h3 class="font-medium text-yellow-900 dark:text-yellow-300 mb-2">æ”¯æŒçš„ç½‘ç«™</h3>
                <p class="text-sm text-yellow-800 dark:text-yellow-400">
                    æ”¯æŒæ‰€æœ‰yt-dlpå…¼å®¹çš„ç½‘ç«™ï¼ŒåŒ…æ‹¬YouTubeã€Bilibiliã€Twitterç­‰1000+ç½‘ç«™
                </p>
            </div>
            
            <div class="bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg p-4">
                <h3 class="font-medium text-green-900 dark:text-green-300 mb-2">å‘½ä»¤æ”¯æŒ</h3>
                <div class="text-sm text-green-800 dark:text-green-400 space-y-1">
                    <p><code>/start</code> - æŸ¥çœ‹å¸®åŠ©ä¿¡æ¯</p>
                    <p><code>/status</code> - æŸ¥çœ‹ç³»ç»ŸçŠ¶æ€</p>
                    <p><code>/downloads</code> - æŸ¥çœ‹ä¸‹è½½åˆ—è¡¨</p>
                </div>
            </div>
        </div>
    </div>
    
</div>
{% endblock %}

{% block extra_scripts %}
<script>
function telegramApp() {
    return {
        config: {
            enabled: false,
            bot_token: '',
            chat_id: '',
            api_id: null,
            api_hash: '',
            push_mode: 'file',
            auto_download: true,
            file_size_limit: 50
        },
        connectionStatus: {
            bot_api: false,
            pyrogram: false
        },
        testing: false,
        
        async init() {
            await this.loadConfig();
        },
        
        async loadConfig() {
            try {
                console.log('ğŸ”„ å¼€å§‹åŠ è½½Telegramé…ç½®');
                const response = await apiRequest('/api/telegram/config');
                console.log('ğŸ“¡ åŠ è½½å“åº”çŠ¶æ€:', response.status);

                if (response.ok) {
                    const data = await response.json();
                    console.log('âœ… åŠ è½½çš„é…ç½®æ•°æ®:', data);

                    // æ­£ç¡®å¤„ç†å¸ƒå°”å€¼ï¼Œç¡®ä¿enabledå­—æ®µæ­£ç¡®æ˜¾ç¤º
                    const processedData = {
                        ...data,
                        enabled: Boolean(data.enabled),
                        auto_download: Boolean(data.auto_download)
                    };

                    this.config = { ...this.config, ...processedData };
                    console.log('âœ… åˆå¹¶åçš„é…ç½®:', this.config);
                } else {
                    console.error('âŒ åŠ è½½é…ç½®å¤±è´¥ï¼ŒçŠ¶æ€ç :', response.status);
                }
            } catch (error) {
                console.error('âŒ åŠ è½½Telegramé…ç½®å¤±è´¥:', error);
            }
        },
        
        async saveConfig() {
            try {
                console.log('ğŸ”„ å¼€å§‹ä¿å­˜Telegramé…ç½®:', this.config);

                const response = await apiRequest('/api/telegram/config', {
                    method: 'POST',
                    body: JSON.stringify(this.config)
                });

                console.log('ğŸ“¡ APIå“åº”çŠ¶æ€:', response.status);

                if (response.ok) {
                    const data = await response.json();
                    console.log('âœ… ä¿å­˜æˆåŠŸ:', data);
                    showNotification('é…ç½®ä¿å­˜æˆåŠŸ', 'success');

                    // é‡æ–°åŠ è½½é…ç½®ä»¥ç¡®è®¤ä¿å­˜æˆåŠŸ
                    await this.loadConfig();
                } else {
                    const data = await response.json();
                    console.error('âŒ ä¿å­˜å¤±è´¥:', data);
                    showNotification(data.error || 'ä¿å­˜å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('âŒ ä¿å­˜é…ç½®æ—¶å‡ºç°å¼‚å¸¸:', error);
                showNotification('ç½‘ç»œé”™è¯¯: ' + error.message, 'error');
            }
        },
        
        async testConnection() {
            if (!this.config.bot_token || !this.config.chat_id) {
                showNotification('è¯·å…ˆé…ç½®Bot Tokenå’ŒChat ID', 'warning');
                return;
            }
            
            this.testing = true;
            
            try {
                const response = await apiRequest('/api/telegram/test', {
                    method: 'POST'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    this.connectionStatus = {
                        bot_api: data.bot_api || false,
                        pyrogram: data.pyrogram || false
                    };
                    
                    if (data.success) {
                        showNotification('è¿æ¥æµ‹è¯•æˆåŠŸ', 'success');
                    } else {
                        showNotification(data.error || 'è¿æ¥æµ‹è¯•å¤±è´¥', 'error');
                    }
                } else {
                    showNotification('æµ‹è¯•å¤±è´¥', 'error');
                }
            } catch (error) {
                showNotification('ç½‘ç»œé”™è¯¯', 'error');
            } finally {
                this.testing = false;
            }
        }
    }
}
</script>
{% endblock %}
